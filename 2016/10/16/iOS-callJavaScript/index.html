<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iOS,Swift,OC,JavaScript,JavaScriptCore,UIWebView,WKWebView,HTML,WebKit," />










<meta name="description" content="OC/Swift与JavaScript交互问题 iOS中如何加载HTML页面？（包括Objective-C和Swift） iOS中如何去执行一段JavaScript代码？（包括Objective-C和Swift） iOS中为什么要使用原生语言去执行一段JavaScript代码？ iOS中如何监听到HTML页面中触发的事件？（JavaScript函数的触发） iOS混合开发中，当JavaScript">
<meta name="keywords" content="iOS,Swift,OC,JavaScript,JavaScriptCore,UIWebView,WKWebView,HTML,WebKit">
<meta property="og:type" content="article">
<meta property="og:title" content="Objective-C&#x2F;Swift与JavaScript交互">
<meta property="og:url" content="http://www.mengyueping.com/2016/10/16/iOS-callJavaScript/index.html">
<meta property="og:site_name" content="孟跃平的技术博客">
<meta property="og:description" content="OC/Swift与JavaScript交互问题 iOS中如何加载HTML页面？（包括Objective-C和Swift） iOS中如何去执行一段JavaScript代码？（包括Objective-C和Swift） iOS中为什么要使用原生语言去执行一段JavaScript代码？ iOS中如何监听到HTML页面中触发的事件？（JavaScript函数的触发） iOS混合开发中，当JavaScript">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-07-01T16:00:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Objective-C&#x2F;Swift与JavaScript交互">
<meta name="twitter:description" content="OC/Swift与JavaScript交互问题 iOS中如何加载HTML页面？（包括Objective-C和Swift） iOS中如何去执行一段JavaScript代码？（包括Objective-C和Swift） iOS中为什么要使用原生语言去执行一段JavaScript代码？ iOS中如何监听到HTML页面中触发的事件？（JavaScript函数的触发） iOS混合开发中，当JavaScript">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.mengyueping.com/2016/10/16/iOS-callJavaScript/"/>





  <title>Objective-C/Swift与JavaScript交互 | 孟跃平的技术博客</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?deacc15534ffb9510cfb94bae354ea45";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">孟跃平的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.mengyueping.com/2016/10/16/iOS-callJavaScript/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟跃平">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟跃平的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Objective-C/Swift与JavaScript交互</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-16T00:00:00+08:00">
                2016-10-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/JavaScriptCore/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScriptCore</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/16/iOS-callJavaScript/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/10/16/iOS-callJavaScript/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/10/16/iOS-callJavaScript/" class="leancloud_visitors" data-flag-title="Objective-C/Swift与JavaScript交互">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="OC-Swift与JavaScript交互"><a href="#OC-Swift与JavaScript交互" class="headerlink" title="OC/Swift与JavaScript交互"></a>OC/Swift与JavaScript交互</h1><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li><code>iOS</code>中如何加载<code>HTML</code>页面？（包括<code>Objective-C</code>和<code>Swift</code>）</li>
<li><code>iOS</code>中如何去执行一段<code>JavaScript</code>代码？（包括<code>Objective-C</code>和<code>Swift</code>）</li>
<li><code>iOS</code>中为什么要使用原生语言去执行一段<code>JavaScript</code>代码？</li>
<li><code>iOS</code>中如何监听到<code>HTML</code>页面中触发的事件？（<code>JavaScript</code>函数的触发）</li>
<li><code>iOS</code>混合开发中，当<code>JavaScript</code>函数触发时，能否发送一些数据给<code>iOS</code>原生，如何发送？</li>
<li><code>iOS</code>混合开发中，当<code>JavaScript</code>函数触发时，能否让<code>OC/Swift</code>执行一些操作，比如调用系统相机等？<a id="more"></a>
</li>
</ul>
<h1 id="iOS中加载HTML页面"><a href="#iOS中加载HTML页面" class="headerlink" title="iOS中加载HTML页面"></a>iOS中加载HTML页面</h1><h2 id="UIWebView"><a href="#UIWebView" class="headerlink" title="UIWebView"></a>UIWebView</h2><h3 id="OC版本"><a href="#OC版本" class="headerlink" title="OC版本"></a>OC版本</h3><p><code>UIWebView</code>是<code>iOS 2.0</code>就有的一个UI控件，是用来加载<code>HTML</code>页面的，属于<code>UIKit</code>框架。基本使用比较简单，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//UI控件设置</span><br><span class="line">  UIWebView *webView = [[UIWebView alloc] initWithFrame:self.view.bounds];</span><br><span class="line">  webView.delegate = self;</span><br><span class="line">  [self.view addSubview:webView];</span><br><span class="line">  NSURL *htmlUrl = [NSURL URLWithString:@&quot;https://www.baidu.com&quot;];</span><br><span class="line">  NSURLRequest *request = [NSURLRequest requestWithURL:htmlUrl];</span><br><span class="line">  [webView loadRequest:request];</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 实现代理 UIWebViewDelegate</span><br><span class="line">- (void)webViewDidStartLoad:(UIWebView *)webView&#123;</span><br><span class="line">	//网页开始加载时调用</span><br><span class="line">&#125;</span><br><span class="line">- (void)webViewDidFinishLoad:(UIWebView *)webView&#123;</span><br><span class="line">	//网页加载完成时调用</span><br><span class="line">&#125;</span><br><span class="line">- (void)webView:(UIWebView *)webView didFailLoadWithError:(NSError *)error&#123;</span><br><span class="line">	//网页加载失败时调用</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Swift版本"><a href="#Swift版本" class="headerlink" title="Swift版本"></a>Swift版本</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UI控件设置</span></span><br><span class="line">  <span class="keyword">let</span> webView = <span class="type">UIWebView</span>(frame: view.bounds)</span><br><span class="line">  webView.delegate = <span class="keyword">self</span></span><br><span class="line">  view.addSubview(webView)</span><br><span class="line">  <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"https://www.baidu.com"</span>)!</span><br><span class="line">  webView.loadRequest(<span class="type">URLRequest</span>(url: url))</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现代理 UIWebViewDelegate</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">UIWebViewDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webViewDidStartLoad</span><span class="params">(<span class="number">_</span> webView: UIWebView)</span></span> &#123;</span><br><span class="line">        <span class="comment">//网页开始加载时调用</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webViewDidFinishLoad</span><span class="params">(<span class="number">_</span> webView: UIWebView)</span></span> &#123;</span><br><span class="line">        <span class="comment">//网页加载完成时调用</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: UIWebView, didFailLoadWithError error: Error)</span></span> &#123;</span><br><span class="line">        <span class="comment">//网页加载失败时调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="WKWebView"><a href="#WKWebView" class="headerlink" title="WKWebView"></a>WKWebView</h2><h3 id="OC版本-1"><a href="#OC版本-1" class="headerlink" title="OC版本"></a>OC版本</h3><p><code>WKWebView</code>是<code>iOS 8.0</code>出现的一个UI控件，是用来加载<code>HTML</code>页面的，属于<code>WebKit</code>框架。基本使用，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WKWebViewConfiguration *configuration = [[WKWebViewConfiguration alloc] init];</span><br><span class="line">WKWebView *webView = [[WKWebView alloc] initWithFrame:self.view.bounds configuration:configuration];</span><br><span class="line">webView.UIDelegate = self;</span><br><span class="line">webView.navigationDelegate = self;</span><br><span class="line">[self.view addSubview:webView];</span><br><span class="line">NSURL *url = [NSURL URLWithString:@&quot;https://www.baidu.com&quot;];</span><br><span class="line">[webView loadRequest:[NSURLRequest requestWithURL:url]];</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//需要遵守协议 WKNavigationDelegate, WKUIDelegate</span><br><span class="line">/*</span><br><span class="line">WKNavigationDelegate实现：</span><br><span class="line">首次载入调用顺序：didStartProvisionalNavigation -&gt; didCommitNavigation -&gt; didFinishNavigation</span><br><span class="line">重定向：didStartProvisionalNavigation -&gt; didReceiveServerRedirectForProvisionalNavigation -&gt; didCommitNavigation -&gt; didFinishNavigation</span><br><span class="line">*/</span><br><span class="line">- (void)webView:(WKWebView *)webView didStartProvisionalNavigation:(null_unspecified WKNavigation *)navigation &#123;</span><br><span class="line">    NSLog(@&quot;--%s&quot;,__func__);</span><br><span class="line">    //页面开始加载时调用</span><br><span class="line">&#125;</span><br><span class="line">- (void)webView:(WKWebView *)webView didCommitNavigation:(null_unspecified WKNavigation *)navigation &#123;</span><br><span class="line">    NSLog(@&quot;--%s&quot;,__func__);</span><br><span class="line">    //当内容开始返回时调用</span><br><span class="line">&#125;</span><br><span class="line">- (void)webView:(WKWebView *)webView didFinishNavigation:(null_unspecified WKNavigation *)navigation &#123;</span><br><span class="line">    NSLog(@&quot;--%s&quot;,__func__);</span><br><span class="line">    //页面加载完成之后调用</span><br><span class="line">&#125;</span><br><span class="line">- (void)webView:(WKWebView *)webView didReceiveServerRedirectForProvisionalNavigation:(null_unspecified WKNavigation *)navigation &#123;</span><br><span class="line">    NSLog(@&quot;--%s&quot;,__func__);</span><br><span class="line">    //服务器重定向页面时调用,并且在 didStartProvisionalNavigation 之后，didCommitNavigation之前调用。</span><br><span class="line">&#125;</span><br><span class="line">- (void)webView:(WKWebView *)webView didFailProvisionalNavigation:(null_unspecified WKNavigation *)navigation withError:(NSError *)error &#123;</span><br><span class="line">    NSLog(@&quot;--%s&quot;,__func__);</span><br><span class="line">    //页面加载失败时调用</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Swift版本-1"><a href="#Swift版本-1" class="headerlink" title="Swift版本"></a>Swift版本</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> configuration = <span class="type">WKWebViewConfiguration</span>()</span><br><span class="line"><span class="keyword">let</span> webView = <span class="type">WKWebView</span>(frame: view.bounds, configuration: configuration)</span><br><span class="line">webView.navigationDelegate = <span class="keyword">self</span></span><br><span class="line">webView.uiDelegate = <span class="keyword">self</span></span><br><span class="line">view.addSubview(webView)</span><br><span class="line"><span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"https://www.baidu.com"</span>)!</span><br><span class="line">webView.load(<span class="type">URLRequest</span>(url: url))</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//需要遵守协议 WKNavigationDelegate, WKUIDelegate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">顺序：didStartProvisionalNavigation -&gt; didCommit -&gt; didFinish</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">WKNavigationDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: WKWebView, didStartProvisionalNavigation navigation: WKNavigation!)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(#function)</span><br><span class="line">        <span class="comment">//页面开始加载时调用</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: WKWebView, didCommit navigation: WKNavigation!)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(#function)</span><br><span class="line">        <span class="comment">//当内容开始返回时调用</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: WKWebView, didFinish navigation: WKNavigation!)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(#function)</span><br><span class="line">        <span class="comment">//页面加载完成之后调用</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: WKWebView, didReceiveServerRedirectForProvisionalNavigation navigation: WKNavigation!)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(#function)</span><br><span class="line">        <span class="comment">//服务器重定向页面时调用.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: WKWebView, didFailProvisionalNavigation navigation: WKNavigation!, withError error: Error)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(#function)</span><br><span class="line">        <span class="comment">//页面加载失败时调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="iOS中执行一段JavaScript代码"><a href="#iOS中执行一段JavaScript代码" class="headerlink" title="iOS中执行一段JavaScript代码"></a>iOS中执行一段JavaScript代码</h1><p>在<code>iOS</code>中使用原生语言去执行<code>JavaScript</code>脚本，是为了对已经加载好的<code>HTML</code>的<code>DOM</code>元素的增、删、改、查。同时，还可以通过执行<code>JavaScript</code>脚本获取<code>DOM</code>对象，进而获取一些<code>HTML</code>的页面信息，比如，通过脚本<code>document.title</code>可以获取当前页面的<code>title</code>,通过脚本<code>document.location.href</code>可以获取当前加载的<code>HTML</code>页面的<code>url</code>。<br>通常这些操作的方法是：使用<code>UIWebView</code>或<code>WKWebView</code>的对象方法执行<code>JavaScript</code>脚本。通常这些操作的时机是：在<code>HTML</code>页面加载完成的原生回调中进行的。</p>
<h2 id="使用UIWebView执行JS代码"><a href="#使用UIWebView执行JS代码" class="headerlink" title="使用UIWebView执行JS代码"></a>使用UIWebView执行JS代码</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--要加载的HTML文件 index.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是一个网页<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="OC版本-2"><a href="#OC版本-2" class="headerlink" title="OC版本"></a>OC版本</h3><p>使用<code>UIWebView</code>的对象方法<code>- (nullable NSString *)stringByEvaluatingJavaScriptFromString:(NSString *)script;</code>来执行一段<code>JavaScript</code>代码。一般是在<code>UIWebView</code>的代理方法：<code>- (void)webViewDidFinishLoad:(UIWebView *)webView;</code>中使用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">UIWebView *webView = [[UIWebView alloc] initWithFrame:self.view.bounds];</span><br><span class="line">webView.delegate = self;</span><br><span class="line">webView.scrollView.hidden = YES;</span><br><span class="line">webView.backgroundColor = [UIColor grayColor];</span><br><span class="line">webView.scalesPageToFit = YES;</span><br><span class="line">[self.view addSubview:webView];</span><br><span class="line">NSURL *htmlUrl = [[NSBundle mainBundle] URLForResource:@&quot;index&quot; withExtension:@&quot;html&quot;];</span><br><span class="line">NSURLRequest *request = [NSURLRequest requestWithURL:htmlUrl];</span><br><span class="line">[webView loadRequest:request];</span><br><span class="line"></span><br><span class="line">//添加网络加载指示器</span><br><span class="line">UIActivityIndicatorView *indicatorView = [[UIActivityIndicatorView alloc] initWithActivityIndicatorStyle:UIActivityIndicatorViewStyleWhiteLarge];</span><br><span class="line">indicatorView.center = CGPointMake(200, 200);</span><br><span class="line">[self.view addSubview:indicatorView];</span><br><span class="line">self.indicatorView = indicatorView;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// 代理</span><br><span class="line">- (void)webViewDidStartLoad:(UIWebView *)webView</span><br><span class="line">&#123;//网页开始加载时调用</span><br><span class="line">    //指示器开始显示动画</span><br><span class="line">    [self.indicatorView startAnimating];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)webViewDidFinishLoad:(UIWebView *)webView</span><br><span class="line">&#123;//网页加载完成时调用</span><br><span class="line">    </span><br><span class="line">    //指示器结束显示动画</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.25 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        webView.scrollView.hidden = NO;</span><br><span class="line">        [self.indicatorView stopAnimating];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    //注意：JavaScript脚本字符串中不需要添加&lt;script&gt;&lt;/script&gt;标签</span><br><span class="line">    NSString *jsStr_1 = @&quot;alert(&apos;JS弹框&apos;)&quot;;</span><br><span class="line">    [webView stringByEvaluatingJavaScriptFromString:jsStr_1];</span><br><span class="line">    </span><br><span class="line">    NSString *jsStr_2 = @&quot;var p = document.getElementsByTagName(&apos;p&apos;)[0];&quot;;</span><br><span class="line">    NSString *jsStr_3 = @&quot;p.innerHTML = &apos;使用JavaScript很🐂&apos;;&quot;;</span><br><span class="line">    NSString *jsStr_4 = @&quot;p.style.background = &apos;red&apos;;document.body.appendChild(p);&quot;;</span><br><span class="line">    [webView stringByEvaluatingJavaScriptFromString:jsStr_2];</span><br><span class="line">    [webView stringByEvaluatingJavaScriptFromString:jsStr_3];</span><br><span class="line">    [webView stringByEvaluatingJavaScriptFromString:jsStr_4];</span><br><span class="line">    </span><br><span class="line">    NSString *jsStr_5 = @&quot;var li = document.createElement(&apos;li&apos;);li.innerHTML=&apos;执行js代码，dom操作元素&apos;;li.style.background = &apos;gray&apos;;document.body.appendChild(li);&quot;;</span><br><span class="line">    [webView stringByEvaluatingJavaScriptFromString:jsStr_5];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Swift版本-2"><a href="#Swift版本-2" class="headerlink" title="Swift版本"></a>Swift版本</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//网络加载指示器</span></span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> indicatorView: <span class="type">UIActivityIndicatorView</span> = &#123;</span><br><span class="line">        <span class="keyword">var</span> indicator = <span class="type">UIActivityIndicatorView</span>(activityIndicatorStyle: .whiteLarge)</span><br><span class="line">        indicator.center = <span class="type">CGPoint</span>(x: <span class="number">200</span>, y: <span class="number">200</span>)</span><br><span class="line">        <span class="keyword">return</span> indicator</span><br><span class="line">    &#125;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> webView = <span class="type">UIWebView</span>(frame: view.bounds)</span><br><span class="line">        webView.delegate = <span class="keyword">self</span></span><br><span class="line">        webView.scrollView.isHidden = <span class="literal">true</span></span><br><span class="line">        webView.backgroundColor = .gray</span><br><span class="line">        webView.scalesPageToFit = <span class="literal">true</span></span><br><span class="line">        view.addSubview(webView)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> url = <span class="type">Bundle</span>.main.url(forResource:<span class="string">"index"</span>, withExtension:<span class="string">"html"</span>)!</span><br><span class="line">        webView.loadRequest(<span class="type">URLRequest</span>(url: url))</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//添加网络加载指示器</span></span><br><span class="line">        view.addSubview(indicatorView)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代理</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">UIWebViewDelegate</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webViewDidStartLoad</span><span class="params">(<span class="number">_</span> webView: UIWebView)</span></span> &#123;<span class="comment">//网页开始加载时调用</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//指示器开始显示动画</span></span><br><span class="line">        indicatorView.startAnimating()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webViewDidFinishLoad</span><span class="params">(<span class="number">_</span> webView: UIWebView)</span></span> &#123;<span class="comment">//网页加载完成时调用</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//指示器结束显示动画</span></span><br><span class="line">        <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: <span class="type">DispatchTime</span>.now() + <span class="number">0.25</span>) &#123; </span><br><span class="line">            webView.scrollView.isHidden = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">self</span>.indicatorView.stopAnimating()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//注意：JavaScript脚本字符串中不需要添加&lt;script&gt;&lt;/script&gt;标签</span></span><br><span class="line">        <span class="keyword">let</span> jsStr_1 = <span class="string">"alert('JS弹框')"</span></span><br><span class="line">        webView.stringByEvaluatingJavaScript(from: jsStr_1)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> jsStr_2 = <span class="string">"var p = document.getElementsByTagName('p')[0];"</span></span><br><span class="line">        <span class="keyword">let</span> jsStr_3 = <span class="string">"p.innerHTML = '使用JavaScript很🐂';"</span></span><br><span class="line">        <span class="keyword">let</span> jsStr_4 = <span class="string">"p.style.background = 'red';document.body.appendChild(p);"</span></span><br><span class="line">        webView.stringByEvaluatingJavaScript(from: jsStr_2)</span><br><span class="line">        webView.stringByEvaluatingJavaScript(from: jsStr_3)</span><br><span class="line">        webView.stringByEvaluatingJavaScript(from: jsStr_4)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> jsStr_5 = <span class="string">"var li = document.createElement('li');li.innerHTML='执行js代码，dom操作元素';li.style.background = 'gray';document.body.appendChild(li);"</span></span><br><span class="line">        webView.stringByEvaluatingJavaScript(from: jsStr_5)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用WKWebView执行JS代码"><a href="#使用WKWebView执行JS代码" class="headerlink" title="使用WKWebView执行JS代码"></a>使用WKWebView执行JS代码</h2><h3 id="OC版本-3"><a href="#OC版本-3" class="headerlink" title="OC版本"></a>OC版本</h3><p>使用<code>WKWebView</code>的对象方法<code>- (void)evaluateJavaScript:(NSString *)javaScriptString completionHandler:(void (^ _Nullable)(_Nullable id, NSError * _Nullable error))completionHandler;</code>来执行一段<code>JavaScript</code>代码。一般是在<code>WKWebView</code>的代理方法：<code>- (void)webView:(WKWebView *)webView didFinishNavigation:(null_unspecified WKNavigation *)navigation;</code>中使用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">WKWebViewConfiguration *configuration = [[WKWebViewConfiguration alloc] init];</span><br><span class="line"></span><br><span class="line">WKWebView *webView = [[WKWebView alloc] initWithFrame:self.view.bounds configuration:configuration];</span><br><span class="line">webView.UIDelegate = self;</span><br><span class="line">webView.navigationDelegate = self;</span><br><span class="line">webView.scrollView.hidden = YES;</span><br><span class="line">webView.backgroundColor = [UIColor grayColor];</span><br><span class="line">[self.view addSubview:webView];</span><br><span class="line">NSURL *url = [[NSBundle mainBundle] URLForResource:@&quot;index&quot; withExtension:@&quot;html&quot;];</span><br><span class="line">[webView loadRequest:[NSURLRequest requestWithURL:url]];</span><br><span class="line"></span><br><span class="line">//添加网络加载指示器</span><br><span class="line">UIActivityIndicatorView *indicatorView = [[UIActivityIndicatorView alloc] initWithActivityIndicatorStyle:UIActivityIndicatorViewStyleWhiteLarge];</span><br><span class="line">indicatorView.center = CGPointMake(200, 200);</span><br><span class="line">[self.view addSubview:indicatorView];</span><br><span class="line">self.indicatorView = indicatorView;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// 代理 WKNavigationDelegate</span><br><span class="line">- (void)webView:(WKWebView *)webView didStartProvisionalNavigation:(null_unspecified WKNavigation *)navigation</span><br><span class="line">&#123;//页面开始加载时调用</span><br><span class="line">    //指示器开始显示动画</span><br><span class="line">    [self.indicatorView startAnimating];</span><br><span class="line">&#125;</span><br><span class="line">- (void)webView:(WKWebView *)webView didFinishNavigation:(null_unspecified WKNavigation *)navigation</span><br><span class="line">&#123; //页面加载完成之后调用</span><br><span class="line">    </span><br><span class="line">    //指示器结束显示动画</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.25 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        webView.scrollView.hidden = NO;</span><br><span class="line">        [self.indicatorView stopAnimating];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    //注意：JavaScript脚本字符串中不需要添加&lt;script&gt;&lt;/script&gt;标签</span><br><span class="line">    NSString *jsStr_1 = @&quot;var p = document.getElementsByTagName(&apos;p&apos;)[0];&quot;;</span><br><span class="line">    NSString *jsStr_2 = @&quot;p.innerHTML = &apos;使用JavaScript很🐂&apos;;&quot;;</span><br><span class="line">    NSString *jsStr_3 = @&quot;p.style.background = &apos;red&apos;;document.body.appendChild(p);&quot;;</span><br><span class="line">    [webView evaluateJavaScript:jsStr_1 completionHandler:nil];</span><br><span class="line">    [webView evaluateJavaScript:jsStr_2 completionHandler:^(id _Nullable value, NSError * _Nullable error) &#123;</span><br><span class="line">        NSLog(@&quot;value: %@&quot;,value); //打印出插入的内容：使用JavaScript很🐂</span><br><span class="line">    &#125;];</span><br><span class="line">    [webView evaluateJavaScript:jsStr_3 completionHandler:nil];</span><br><span class="line">    </span><br><span class="line">    NSString *jsStr_4 = @&quot;var li = document.createElement(&apos;li&apos;);li.innerHTML=&apos;执行js代码，dom操作元素&apos;;li.style.background = &apos;gray&apos;;document.body.appendChild(li);&quot;;</span><br><span class="line">    [webView evaluateJavaScript:jsStr_4 completionHandler:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Swift版本-3"><a href="#Swift版本-3" class="headerlink" title="Swift版本"></a>Swift版本</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    <span class="comment">//网络加载指示器</span></span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> indicatorView: <span class="type">UIActivityIndicatorView</span> = &#123;</span><br><span class="line">        <span class="keyword">var</span> indicator = <span class="type">UIActivityIndicatorView</span>(activityIndicatorStyle: .whiteLarge)</span><br><span class="line">        indicator.center = <span class="type">CGPoint</span>(x: <span class="number">200</span>, y: <span class="number">200</span>)</span><br><span class="line">        <span class="keyword">return</span> indicator</span><br><span class="line">    &#125;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> configuration = <span class="type">WKWebViewConfiguration</span>()</span><br><span class="line">        <span class="keyword">let</span> webView = <span class="type">WKWebView</span>(frame: view.bounds, configuration: configuration)</span><br><span class="line">        webView.scrollView.isHidden = <span class="literal">true</span></span><br><span class="line">        webView.backgroundColor = .gray</span><br><span class="line">        webView.navigationDelegate = <span class="keyword">self</span></span><br><span class="line">        webView.uiDelegate = <span class="keyword">self</span></span><br><span class="line">        view.addSubview(webView)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> url = <span class="type">Bundle</span>.main.url(forResource:<span class="string">"index"</span>, withExtension:<span class="string">"html"</span>)!</span><br><span class="line">        webView.load(<span class="type">URLRequest</span>(url: url))</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//添加网络加载指示器</span></span><br><span class="line">        view.addSubview(indicatorView)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//代理 WKNavigationDelegate</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">WKNavigationDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: WKWebView, didStartProvisionalNavigation navigation: WKNavigation!)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(#function) <span class="comment">//页面开始加载时调用</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//指示器开始显示动画</span></span><br><span class="line">        indicatorView.startAnimating()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: WKWebView, didFinish navigation: WKNavigation!)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(#function) <span class="comment">//页面加载完成之后调用</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//指示器结束显示动画</span></span><br><span class="line">        <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: <span class="type">DispatchTime</span>.now() + <span class="number">0.25</span>) &#123;</span><br><span class="line">            webView.scrollView.isHidden = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">self</span>.indicatorView.stopAnimating()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//注意：JavaScript脚本字符串中不需要添加&lt;script&gt;&lt;/script&gt;标签</span></span><br><span class="line">        <span class="keyword">let</span> jsStr_1 = <span class="string">"var p = document.getElementsByTagName('p')[0];"</span></span><br><span class="line">        <span class="keyword">let</span> jsStr_2 = <span class="string">"p.innerHTML = '使用JavaScript很🐂';"</span></span><br><span class="line">        <span class="keyword">let</span> jsStr_3 = <span class="string">"p.style.background = 'red';document.body.appendChild(p);"</span></span><br><span class="line">        webView.evaluateJavaScript(jsStr_1, completionHandler: <span class="literal">nil</span>)</span><br><span class="line">        webView.evaluateJavaScript(jsStr_2) &#123; (value, error) <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(value ?? <span class="string">""</span>) <span class="comment">//打印出插入的内容：使用JavaScript很🐂</span></span><br><span class="line">        &#125;</span><br><span class="line">        webView.evaluateJavaScript(jsStr_3, completionHandler: <span class="literal">nil</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> jsStr_4 = <span class="string">"var li = document.createElement('li');li.innerHTML='执行js代码，dom操作元素';li.style.background = 'gray';document.body.appendChild(li);"</span></span><br><span class="line">        webView.evaluateJavaScript(jsStr_4, completionHandler: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="iOS中监听JavaScript函数调用"><a href="#iOS中监听JavaScript函数调用" class="headerlink" title="iOS中监听JavaScript函数调用"></a>iOS中监听JavaScript函数调用</h1><p>在<code>iOS</code>混合<code>HTML</code>开发中，如何去监听<code>HTML</code>页面中一个<code>JavaScript</code>函数的调用，这是在需求中经常遇到的。比如，在一个混合页面中，需要点击<code>HTML</code>中的某个按钮标签，调用iPhone系统相机，而相机的触发必须调用<code>iOS</code>原生方法。再比如，在一个混合页面中，需要点击<code>HTML</code>中的某个支付按钮标签，调用iPhone系统已经安装的支付宝应用进行支付操作，来实现应用间的传参跳转，就需要调用<code>支付宝SDK</code>的<code>iOS</code>原生方法。又比如，在混合开发中，需要从一个<code>HTML</code>页面跳转到我的原生页面，并且传送相应的参数，就需要监听<code>JavaScript</code>事件，调用原生控制器跳转方法。这又被很多人称为用<code>JavaScript</code>调用<code>iOS</code>原生代码，个人认为这种说法是不准确的。确切的说，<code>iOS</code>中监听<code>JavaScript</code>函数调用，并作出相应的行为，比较准确。</p>
<h2 id="使用UIWebView监听JS函数调用"><a href="#使用UIWebView监听JS函数调用" class="headerlink" title="使用UIWebView监听JS函数调用"></a>使用UIWebView监听JS函数调用</h2><p>在<code>HTML</code>页面中，对要触发的<code>JavaScript</code>方法中，使用<code>window.location.href =</code>实现一个页面重定向。当触发页面中<code>JavaScript</code>方法，即会调用<code>window.location.href =</code>进行页面重定向时，此时<code>UIWebView</code>代理方法<code>- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType;</code>会监听到页面的重定向，并且可以获取请求对象，<code>NSURLRequest</code>对象<code>request</code>，从<code>request</code>中可以获得重定向的地址。可以对要重定向的地址进行重新定义协议，例如，<code>&#39;mengyueping.com://&#39;</code>，后面可以拼接上要触发的<code>OC/Swift</code>方法名，<code>&#39;mengyueping.com://openCamera&#39;</code>，在代理中拦截到完整协议地址，可以通过截取获得<code>OC/Swift</code>方法名，然后根据方法名给方法发送消息，触发方法，从而达到监听<code>JavaScript</code>函数调用的目的。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--加载的本地HTML--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"openCamera()"</span>&gt;</span>访问相册<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://baidu.com"</span>&gt;</span>百度<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"field"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">            function openCamera() &#123;</span></span><br><span class="line"><span class="undefined">                document.getElementById('field').value = "赋值一下";</span></span><br><span class="line"><span class="undefined">                window.location.href = 'mengyueping.com://openCamera'; //自定义协议</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="OC版本-4"><a href="#OC版本-4" class="headerlink" title="OC版本"></a>OC版本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">UIWebView *webView = [[UIWebView alloc] initWithFrame:self.view.bounds];</span><br><span class="line">webView.delegate = self;</span><br><span class="line">webView.backgroundColor = [UIColor grayColor];</span><br><span class="line">webView.scalesPageToFit = YES;</span><br><span class="line">[self.view addSubview:webView];</span><br><span class="line"></span><br><span class="line">NSURL *htmlUrl = [[NSBundle mainBundle] URLForResource:@&quot;index&quot; withExtension:@&quot;html&quot;];</span><br><span class="line">[webView loadRequest:[NSURLRequest requestWithURL:htmlUrl]];</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//代理 UIWebViewDelegate</span><br><span class="line">- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType</span><br><span class="line">&#123;</span><br><span class="line">    NSString *url = request.URL.absoluteString;</span><br><span class="line">    NSRange range = [url rangeOfString:@&quot;mengyueping.com://&quot;]; //自定义协议</span><br><span class="line">    NSUInteger location = range.location;</span><br><span class="line">    </span><br><span class="line">    if (location != NSNotFound) &#123;</span><br><span class="line">        NSString *str = [url substringFromIndex:(location + range.length)];</span><br><span class="line">        SEL selector = NSSelectorFromString(str);</span><br><span class="line">        //警告：PerformSelector may cause a leak because its selector is unknown</span><br><span class="line">        //[self performSelector:selector];</span><br><span class="line">        [self performSelector:selector withObject:nil afterDelay:0.0];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// iOS原生方法访问相册</span><br><span class="line">- (void)openCamera</span><br><span class="line">&#123;</span><br><span class="line">    UIImagePickerController *picker = [[UIImagePickerController alloc] init];</span><br><span class="line">    picker.sourceType = UIImagePickerControllerSourceTypePhotoLibrary;</span><br><span class="line">    [self presentViewController:picker animated:YES completion:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Swift版本-4"><a href="#Swift版本-4" class="headerlink" title="Swift版本"></a>Swift版本</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> webView = <span class="type">UIWebView</span>(frame: view.bounds)</span><br><span class="line">        webView.delegate = <span class="keyword">self</span></span><br><span class="line">        webView.backgroundColor = .gray</span><br><span class="line">        webView.scalesPageToFit = <span class="literal">true</span></span><br><span class="line">        view.addSubview(webView)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> url = <span class="type">Bundle</span>.main.url(forResource:<span class="string">"index"</span>, withExtension:<span class="string">"html"</span>)!</span><br><span class="line">        webView.loadRequest(<span class="type">URLRequest</span>(url: url))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// iOS原生方法访问相册</span></span><br><span class="line">    <span class="meta">@objc</span> <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">openCamera</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> pickerVC = <span class="type">UIImagePickerController</span>()</span><br><span class="line">        pickerVC.sourceType = .photoLibrary</span><br><span class="line">        <span class="keyword">self</span>.present(pickerVC, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代理 UIWebViewDelegate</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">UIWebViewDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: UIWebView, shouldStartLoadWith request: URLRequest, navigationType: UIWebViewNavigationType)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> url = request.url?.absoluteString</span><br><span class="line">        <span class="keyword">let</span> range = url?.range(of: <span class="string">"mengyueping.com://"</span>) <span class="comment">//自定义协议</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> <span class="number">_</span> = range <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> str = url?.substring(from: <span class="string">"mengyueping.com://"</span>.endIndex)</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> selStr = str <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> selector = <span class="type">Selector</span>(selStr)</span><br><span class="line">        perform(selector)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用WKWebView监听JS函数调用"><a href="#使用WKWebView监听JS函数调用" class="headerlink" title="使用WKWebView监听JS函数调用"></a>使用WKWebView监听JS函数调用</h2><h3 id="OC版本-5"><a href="#OC版本-5" class="headerlink" title="OC版本"></a>OC版本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// app注册方法，供JS调用</span><br><span class="line">WKWebViewConfiguration *configuration = [[WKWebViewConfiguration alloc] init];</span><br><span class="line"></span><br><span class="line">WKWebView *webView = [[WKWebView alloc] initWithFrame:self.view.bounds configuration:configuration];</span><br><span class="line">webView.UIDelegate = self;</span><br><span class="line">webView.navigationDelegate = self;</span><br><span class="line">webView.backgroundColor = [UIColor grayColor];</span><br><span class="line">[self.view addSubview:webView];</span><br><span class="line">NSURL *url = [[NSBundle mainBundle] URLForResource:@&quot;index&quot; withExtension:@&quot;html&quot;];</span><br><span class="line">[webView loadRequest:[NSURLRequest requestWithURL:url]];</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// 代理 WKNavigationDelegate</span><br><span class="line">- (void)webView:(WKWebView *)webView didReceiveServerRedirectForProvisionalNavigation:(null_unspecified WKNavigation *)navigation</span><br><span class="line">&#123; //页面重定向时调用，不是每次都调用，不准确</span><br><span class="line">    NSLog(@&quot;navigation: %@&quot;,navigation);</span><br><span class="line">&#125;</span><br><span class="line">- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler</span><br><span class="line">&#123;//在发送请求之前，决定是否跳转，可以截获发送的请求</span><br><span class="line">    </span><br><span class="line">    NSString *url = navigationAction.request.URL.absoluteString;</span><br><span class="line">    NSRange range = [url rangeOfString:@&quot;mengyueping.com://&quot;]; //自定义协议</span><br><span class="line">    NSUInteger location = range.location;</span><br><span class="line">    </span><br><span class="line">    if (location != NSNotFound) &#123;</span><br><span class="line">        NSString *str = [url substringFromIndex:(location + range.length)];</span><br><span class="line">        SEL selector = NSSelectorFromString(str);</span><br><span class="line">        //警告：PerformSelector may cause a leak because its selector is unknown</span><br><span class="line">        //[self performSelector:selector];</span><br><span class="line">        [self performSelector:selector withObject:nil afterDelay:0.0];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    decisionHandler(WKNavigationActionPolicyAllow);</span><br><span class="line">&#125;</span><br><span class="line">- (void)webView:(WKWebView *)webView decidePolicyForNavigationResponse:(WKNavigationResponse *)navigationResponse decisionHandler:(void (^)(WKNavigationResponsePolicy))decisionHandler</span><br><span class="line">&#123;// 在收到响应后，决定是否跳转，可以截获服务器的响应数据</span><br><span class="line">    decisionHandler(WKNavigationResponsePolicyAllow);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// iOS原生方法访问相册</span><br><span class="line">- (void)openCamera</span><br><span class="line">&#123;</span><br><span class="line">    UIImagePickerController *picker = [[UIImagePickerController alloc] init];</span><br><span class="line">    picker.sourceType = UIImagePickerControllerSourceTypePhotoLibrary;</span><br><span class="line">    [self presentViewController:picker animated:YES completion:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Swift版本-5"><a href="#Swift版本-5" class="headerlink" title="Swift版本"></a>Swift版本</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> configuration = <span class="type">WKWebViewConfiguration</span>()</span><br><span class="line">        <span class="keyword">let</span> webView = <span class="type">WKWebView</span>(frame: view.bounds, configuration: configuration)</span><br><span class="line">        webView.backgroundColor = .gray</span><br><span class="line">        webView.navigationDelegate = <span class="keyword">self</span></span><br><span class="line">        webView.uiDelegate = <span class="keyword">self</span></span><br><span class="line">        view.addSubview(webView)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> url = <span class="type">Bundle</span>.main.url(forResource:<span class="string">"index"</span>, withExtension:<span class="string">"html"</span>)!</span><br><span class="line">        webView.load(<span class="type">URLRequest</span>(url: url))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// iOS原生方法访问相册</span></span><br><span class="line">    <span class="meta">@objc</span> <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">openCamera</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> pickerVC = <span class="type">UIImagePickerController</span>()</span><br><span class="line">        pickerVC.sourceType = .photoLibrary</span><br><span class="line">        <span class="keyword">self</span>.present(pickerVC, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代理 WKNavigationDelegate</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">WKNavigationDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: WKWebView, didReceiveServerRedirectForProvisionalNavigation navigation: WKNavigation!)</span></span> &#123; </span><br><span class="line">        <span class="comment">//页面重定向时调用，不是每次都调用，不准确</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: WKWebView, decidePolicyFor navigationAction: WKNavigationAction, decisionHandler: @escaping <span class="params">(WKNavigationActionPolicy)</span></span></span> -&gt; <span class="type">Void</span>) &#123; </span><br><span class="line">        <span class="comment">// 在发送请求之前，决定是否跳转，可以截获发送的请求</span></span><br><span class="line">        decisionHandler(.allow)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> url = navigationAction.request.url?.absoluteString</span><br><span class="line">        <span class="keyword">let</span> range = url?.range(of: <span class="string">"mengyueping.com://"</span>) <span class="comment">//自定义协议</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> <span class="number">_</span> = range <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> str = url?.substring(from: <span class="string">"mengyueping.com://"</span>.endIndex)</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> selStr = str <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> selector = <span class="type">Selector</span>(selStr)</span><br><span class="line">        perform(selector)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: WKWebView, decidePolicyFor navigationResponse: WKNavigationResponse, decisionHandler: @escaping <span class="params">(WKNavigationResponsePolicy)</span></span></span> -&gt; <span class="type">Void</span>) &#123; </span><br><span class="line">        <span class="comment">// 在收到响应后，决定是否跳转，可以截获服务器的响应数据</span></span><br><span class="line">        decisionHandler(.allow)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: WKWebView, didStartProvisionalNavigation navigation: WKNavigation!)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(#function) <span class="comment">//页面开始加载时调用</span></span><br><span class="line">        <span class="comment">// 不是每次都调用，只有decisionHandler(.allow)时才能调用此方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="WKWebView与JS之间的通信"><a href="#WKWebView与JS之间的通信" class="headerlink" title="WKWebView与JS之间的通信"></a>WKWebView与JS之间的通信</h2><p><code>iOS</code>的<code>WebKit</code>中，为<code>JavaScript</code>提供了一个发消息的通道，是通过<code>WKUserContentController</code>类实现的，可以通过配置类<code>WKWebViewConfiguration</code>配置到<code>WKWebView</code>对象上。并且<code>WKUserContentController</code>的对象可以添加一个脚本信息处理器，(<code>addScriptMessageHandler: name:</code> 或 <code>add(_ scriptMessageHandler: WKScriptMessageHandler, name: String)</code>)，通过实现协议<code>WKScriptMessageHandler</code>来接收处理<code>JS</code>脚本发送过来信息。</p>
<blockquote>
<p><code>WKWebViewConfiguration</code>：是<code>WKWebView</code>初始化时的配置类，里面存储着初始化<code>WKWebView</code>的一系列属性。<br><code>WKUserContentController</code>：为<code>JavaScript</code>提供了一个发送消息的通道，并且可以向页面注入<code>JavaScript</code>的类。可以在配置类&gt; <code>WKWebViewConfiguration</code>属性中，配置此类。<br><code>WKScriptMessageHandler</code>：一个协议，协议只有一个方法，页面执行特定<code>JavaScript</code>的一个回调，这个特定<code>JavaScript</code>格式为<code>window.webkit.messageHandlers.&lt;name&gt;.postMessage(&lt;messageBody&gt;);</code></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.html 要加载的HTML，及通信脚本 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"sendMsgToiOS()"</span>&gt;</span>点击给iOS原生发送消息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://baidu.com"</span>&gt;</span>百度<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    function sendMsgToiOS() &#123;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        var ua = navigator.userAgent.toLowerCase();</span></span><br><span class="line"><span class="undefined">        if (!!ua.match(/\(i[^;]+;( u;)? cpu.+mac os x/)) &#123; // iOS   Mac OS</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            var JSCallIOS = function () &#123;</span></span><br><span class="line"><span class="undefined">                //发送给 iOS 原生的 json 数据</span></span><br><span class="line"><span class="undefined">                var message = &#123;</span></span><br><span class="line"><span class="undefined">                    'method': 'push', </span></span><br><span class="line"><span class="undefined">                    'name' : '王小锌',</span></span><br><span class="line"><span class="undefined">                    'title' : '朋友圈',  </span></span><br><span class="line"><span class="undefined">                    'url': 'http://www.baidu.com'</span></span><br><span class="line"><span class="undefined">                &#125;;</span></span><br><span class="line"><span class="undefined">                //JS 脚本向 iOS原生传递消息</span></span><br><span class="line"><span class="undefined">                window.webkit.messageHandlers.JSMessageToIOS.postMessage(message);</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">            JSCallIOS();</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        &#125; else if (/android/.test(ua)) &#123; // 安卓</span></span><br><span class="line"><span class="undefined">            window.android.finish();</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="OC版本-6"><a href="#OC版本-6" class="headerlink" title="OC版本"></a>OC版本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 为JS提供了一个发送消息的通道，且可以向页面注入JS的类。</span><br><span class="line">WKUserContentController *userContentController = [[WKUserContentController alloc] init];</span><br><span class="line">[userContentController addScriptMessageHandler:self name:@&quot;JSMessageToIOS&quot;]; // &lt;WKScriptMessageHandler&gt;</span><br><span class="line"></span><br><span class="line">// 添加一个脚本信息处理器。self遵守协议WKScriptMessageHandler</span><br><span class="line">// 脚本信息处理器，可以接收JS脚本发送过来的消息。JS脚本通过`window.webkit.messageHandlers.&lt;name&gt;.postMessage(&lt;messageBody&gt;)`发送消息。</span><br><span class="line">// 脚本处理器中监听的名字是js脚本里面消息发送的名字。                 window.webkit.messageHandlers.JSMessageToIOS.postMessage(message);</span><br><span class="line"></span><br><span class="line">// 配置</span><br><span class="line">WKWebViewConfiguration *configuration = [[WKWebViewConfiguration alloc] init];</span><br><span class="line">configuration.userContentController = userContentController; //配置消息通道</span><br><span class="line"></span><br><span class="line">WKWebView *webView = [[WKWebView alloc] initWithFrame:self.view.bounds configuration:configuration];</span><br><span class="line">webView.UIDelegate = self;  //&lt;WKUIDelegate&gt;</span><br><span class="line">webView.navigationDelegate = self; //&lt;WKNavigationDelegate&gt;</span><br><span class="line">webView.backgroundColor = [UIColor grayColor];</span><br><span class="line">[self.view addSubview:webView];</span><br><span class="line">NSURL *url = [[NSBundle mainBundle] URLForResource:@&quot;index&quot; withExtension:@&quot;html&quot;];</span><br><span class="line">[webView loadRequest:[NSURLRequest requestWithURL:url]];</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - 协议 WKScriptMessageHandler</span><br><span class="line">// 当JS给OC发送消息时，此回调中执行消息处理</span><br><span class="line">- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;JS传递过来的消息-message.body: %@&quot;,message.body);</span><br><span class="line">    </span><br><span class="line">    //收到JS传递过来的消息回调，可以做一些原生想要做的事情。--&gt; JS向原生OC传递消息。</span><br><span class="line">    //发送网络请求，页面跳转，打开相机等</span><br><span class="line"></span><br><span class="line">    [self openCamera];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// iOS原生方法访问相册</span><br><span class="line">- (void)openCamera</span><br><span class="line">&#123;</span><br><span class="line">    UIImagePickerController *picker = [[UIImagePickerController alloc] init];</span><br><span class="line">    picker.sourceType = UIImagePickerControllerSourceTypePhotoLibrary;</span><br><span class="line">    [self presentViewController:picker animated:YES completion:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Swift版本-6"><a href="#Swift版本-6" class="headerlink" title="Swift版本"></a>Swift版本</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为JS提供了一个发送消息的通道，且可以向页面注入JS的类。</span></span><br><span class="line"><span class="keyword">let</span> userContentController = <span class="type">WKUserContentController</span>()</span><br><span class="line">userContentController.add(<span class="keyword">self</span>, name: <span class="string">"JSMessageToIOS"</span>)</span><br><span class="line"><span class="comment">// 添加一个脚本信息处理器。self遵守协议WKScriptMessageHandler</span></span><br><span class="line"><span class="comment">// 脚本信息处理器，可以接收JS脚本发送过来的消息。JS脚本通过`window.webkit.messageHandlers.&lt;name&gt;.postMessage(&lt;messageBody&gt;)`发送消息。</span></span><br><span class="line"><span class="comment">// 脚本处理器中监听的名字是js脚本里面消息发送的名字。          window.webkit.messageHandlers.JSMessageToIOS.postMessage(message);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置</span></span><br><span class="line"><span class="keyword">let</span> configuration = <span class="type">WKWebViewConfiguration</span>()</span><br><span class="line">configuration.userContentController = userContentController</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> webView = <span class="type">WKWebView</span>(frame: view.bounds, configuration: configuration)</span><br><span class="line">webView.backgroundColor = .gray</span><br><span class="line">webView.navigationDelegate = <span class="keyword">self</span></span><br><span class="line">webView.uiDelegate = <span class="keyword">self</span></span><br><span class="line">view.addSubview(webView)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> url = <span class="type">Bundle</span>.main.url(forResource:<span class="string">"index"</span>, withExtension:<span class="string">"html"</span>)!</span><br><span class="line">webView.load(<span class="type">URLRequest</span>(url: url))</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">WKScriptMessageHandler</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">userContentController</span><span class="params">(<span class="number">_</span> userContentController: WKUserContentController, didReceive message: WKScriptMessage)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 当JS给OC发送消息时，此回调中执行消息处理</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"JS传递过来的消息-message.body:<span class="subst">\(message.body)</span>, name：<span class="subst">\(message.name)</span>"</span>);</span><br><span class="line">        <span class="comment">//iOS和js统一好的名字：message.name</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//收到JS传递过来的消息回调，可以做一些原生想要做的事情。--&gt; JS向原生OC传递消息。</span></span><br><span class="line">        <span class="comment">//发送网络请求，页面跳转，打开相机等</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> vc = <span class="type">UIViewController</span>()</span><br><span class="line">        vc.title = <span class="string">"name：<span class="subst">\(message.name)</span>"</span></span><br><span class="line">        vc.view = &#123;</span><br><span class="line">            <span class="keyword">let</span> v = <span class="type">UITextView</span>(frame: <span class="keyword">self</span>.view.bounds)</span><br><span class="line">            v.text = <span class="string">"body: <span class="subst">\(message.body)</span>"</span></span><br><span class="line">            <span class="keyword">return</span> v</span><br><span class="line">        &#125;()</span><br><span class="line">        <span class="keyword">let</span> nav = <span class="type">UINavigationController</span>(rootViewController: vc)</span><br><span class="line">        <span class="keyword">self</span>.present(nav, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="iOS中利用JavaScriptCore交互JS"><a href="#iOS中利用JavaScriptCore交互JS" class="headerlink" title="iOS中利用JavaScriptCore交互JS"></a>iOS中利用JavaScriptCore交互JS</h1><p><code>JavaScriptCore.framework</code>是<code>iOS7</code>以后推出的一个<code>JS</code>与<code>OC</code>交互的框架，是使用<code>OC</code>语言对<code>WebKit</code>的<code>JS</code>引擎进行的封装。之后引入<code>Swift</code>。<br>使用时导入头文件<code>#import &lt;JavaScriptCore/JavaScriptCore.h&gt;</code>或<code>import JavaScriptCore</code>。相关类：<code>JSContext</code>、<code>JSValue</code>、<code>JSManagedValue</code>、<code>JSVirtualMachine</code>、<code>JSExport</code>。</p>
<h2 id="使用JSContext运行JS代码"><a href="#使用JSContext运行JS代码" class="headerlink" title="使用JSContext运行JS代码"></a>使用JSContext运行JS代码</h2><p><code>JSContext</code>是运行<code>JS</code>代码的环境，一个<code>JSContext</code>是一个全局环境的实例。<code>JSContext</code>类似<code>window</code>对象。通过对象方法<code>- (JSValue *)evaluateScript:(NSString *)script;</code>来运行<code>JS</code>代码。</p>
<p><code>JSValue</code>包含了每一个<code>JS</code>类型的值。通过<code>JSValue</code>可以将<code>OC</code>中的类型转换为<code>JS</code>中的类型，也可将<code>JS</code>中的类型转为<code>OC</code>中的类型。类型对照如下：</p>
<p><pre><br>    OC Swift type         |   JavaScript type<br>+++++++++++++++++++++++++++++++++++++++++++++++++++++++<br>         nil              |     undefined<br>        NSNull            |        null<br>  NSString String         |       string<br>       NSNumber           |   number, boolean<br>NSDictionary Dictionary   |   Object object<br>  NSArray  Array          |    Array object<br>        NSDate            |     Date object<br>       NSBlock (1)        |   Function object (1)<br>          id (2)          |   Wrapper object (2)<br>        Class (3)         | Constructor object (3)<br></pre><br><code>JSValue</code>都是通过<code>JSContext</code>返回或者创建的，并没有构造方法。每一个<code>JSValue</code>对象都要强引用关联一个<code>JSContext</code>。当与<code>JSContext</code>对象关联的所有<code>JSValue</code>释放后，<code>JSContext</code>也会释放。我们对<code>JS</code>的数值、对象、函数等进行操作，都是通过<code>JSValue</code>对象来实现的。<code>JSValue</code>是 <code>JS</code> 和 <code>OC/Swift</code>数据和方法的桥梁,封装了<code>JS</code>与<code>OC/Swift</code>中的对应的类型，以及如何通过<code>OC/Swift</code>方法调用<code>JS</code>函数的<code>API</code>等</p>
<h3 id="初始化JSContext对象及异常处理"><a href="#初始化JSContext对象及异常处理" class="headerlink" title="初始化JSContext对象及异常处理"></a>初始化JSContext对象及异常处理</h3><p><code>OC/Swift</code>异常会在运行时被<code>Xcode</code>捕获，<code>JSContext</code>中执行的<code>JS</code>如果出现异常，只会被<code>JSContext</code>捕获并存储在<code>exception</code>属性上，而不会向外抛出。时刻检查<code>JSContext</code>对象的<code>exception</code>是否为<code>nil</code>显然是不合适的，更合理的方法是，给<code>JSContext</code>对象设置<code>exceptionHandler</code>回调属性，它接受的是<code>void(^exceptionHandler)(JSContext *context, JSValue *exceptionValue)</code>形式的<code>block</code>，或<code>((JSContext?, JSValue?) -&gt; Swift.Void)</code>形式的闭包。其默认值就是将传入的<code>exceptionValue</code>赋给传入的<code>context</code>的<code>exception</code>属性。这样<code>JS</code>运行发生异常的时候，在<code>Block/Closure</code>中可以立即知道，通过设置<code>Block/Closure</code>中参数<code>context.exception</code>属性，可以观察和记录语法、类型以及运行时错误。</p>
<h4 id="OC版本-7"><a href="#OC版本-7" class="headerlink" title="OC版本"></a>OC版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">JSContext *context = [[JSContext alloc] init];</span><br><span class="line">// 异常处理回调</span><br><span class="line">context.exceptionHandler = ^(JSContext *context, JSValue *exception) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, exception);</span><br><span class="line">    context.exception = exception;</span><br><span class="line">    /*</span><br><span class="line">        此处打印js异常错误，JSContext不会主动抛出js异常。</span><br><span class="line">        常见异常：</span><br><span class="line">            ReferenceError: Can&apos;t find variable:</span><br><span class="line">            TypeError: undefined is not an object</span><br><span class="line">    */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="Swift版本-7"><a href="#Swift版本-7" class="headerlink" title="Swift版本"></a>Swift版本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: 初始化JSContext对象及异常处理</span></span><br><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> context = <span class="type">JSContext</span>()!</span><br><span class="line">context.exceptionHandler = &#123; (context, exception) <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> excep = exception <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print</span>(excep)</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此处打印js异常错误，JSContext不会主动抛出js异常。</span></span><br><span class="line"><span class="comment">    常见异常：</span></span><br><span class="line"><span class="comment">        ReferenceError: Can't find variable:</span></span><br><span class="line"><span class="comment">        TypeError: undefined is not an object</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    context?.exception = excep</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="执行带返回结果js脚本"><a href="#执行带返回结果js脚本" class="headerlink" title="执行带返回结果js脚本"></a>执行带返回结果js脚本</h3><p>如果执行的<code>js</code>脚本有返回结果，则<code>- (JSValue *)evaluateScript:(NSString *)script;</code>执行后返回的<code>JSValue</code>对象，包含返回的结果。可以解析为<code>JS</code>类型，也可以调用<code>JSValue</code>对象<code>API</code>方法，解析为<code>OC</code>对象。</p>
<h4 id="OC版本-8"><a href="#OC版本-8" class="headerlink" title="OC版本"></a>OC版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NSString *jsStr1 = @&quot;1+2&quot;;</span><br><span class="line">JSValue *value1 = [context evaluateScript:jsStr1]; // 返回的JSValue对象，存储的是js计算的返回结果。不存储定义的变量。</span><br><span class="line">NSLog(@&quot;value1 JS: %@  -&gt; OC: %@&quot;,value1, value1.toNumber); // 3  3</span><br></pre></td></tr></table></figure>
<h4 id="Swift版本-8"><a href="#Swift版本-8" class="headerlink" title="Swift版本"></a>Swift版本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: 执行带返回结果js脚本</span></span><br><span class="line"><span class="keyword">let</span> jsStr1 = <span class="string">"1+2"</span></span><br><span class="line"><span class="keyword">let</span> jsvalue1 = context.evaluateScript(jsStr1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"value1 JS: <span class="subst">\(String(describing: jsvalue1)</span>)  -&gt; Swift: <span class="subst">\(String(describing: jsvalue1?.toNumber()</span>))"</span>)</span><br><span class="line"><span class="comment">// value1 JS: Optional(3)  -&gt; Swift: Optional(3)</span></span><br></pre></td></tr></table></figure>
<h3 id="执行不带返回结果js脚本"><a href="#执行不带返回结果js脚本" class="headerlink" title="执行不带返回结果js脚本"></a>执行不带返回结果js脚本</h3><p>如果执行的<code>js</code>脚本没有返回结果，则<code>- (JSValue *)evaluateScript:(NSString *)script;</code>执行后返回的<code>JSValue</code>对象，解析为<code>JS</code>是 <code>undefined</code>，对应的<code>OC</code>是<code>(null)</code>。</p>
<h4 id="OC版本-9"><a href="#OC版本-9" class="headerlink" title="OC版本"></a>OC版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NSString *jsStr2 = @&quot;var a = 1; var b = 2;&quot;;</span><br><span class="line">JSValue *value2 = [context evaluateScript:jsStr2];</span><br><span class="line">NSLog(@&quot;value2 JS: %@  -&gt; OC: %@&quot;,value2, value2.toObject); // value2 JS: undefined  -&gt; OC: (null)</span><br></pre></td></tr></table></figure>
<h4 id="Swift版本-9"><a href="#Swift版本-9" class="headerlink" title="Swift版本"></a>Swift版本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: 执行不带返回结果js脚本</span></span><br><span class="line"><span class="keyword">let</span> jsStr2 = <span class="string">"var a = 1; var b = 2;"</span></span><br><span class="line"><span class="keyword">let</span> jsvalue2 = context.evaluateScript(jsStr2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"value2 JS: <span class="subst">\(String(describing: jsvalue2)</span>)  -&gt; Swift: <span class="subst">\(String(describing: jsvalue2?.toObject)</span>)"</span>);</span><br><span class="line"><span class="comment">//value2 JS: Optional(undefined)  -&gt; Swift: Optional((Function))</span></span><br></pre></td></tr></table></figure>
<h3 id="取出js脚本执行后存储在JSContext对象中的变量"><a href="#取出js脚本执行后存储在JSContext对象中的变量" class="headerlink" title="取出js脚本执行后存储在JSContext对象中的变量"></a>取出js脚本执行后存储在JSContext对象中的变量</h3><p>当<code>JSContext</code>对象调用方法<code>- (JSValue *)evaluateScript:(NSString *)script;</code>来执行<code>js</code>脚本时，会把<code>JS</code>中定义的变量函数等存储到<code>JSContext</code>对象中，并且可以通过<code>key-value</code>方法取出，取出获得的是<code>JSValue</code>对象。这样就可以通过取出的<code>JSValue</code>对象转换<code>js</code>脚本中定义的<code>JS</code>变量为<code>OC</code>对象来使用，或可以通过取出的<code>JSValue</code>对象调用<code>js</code>脚本中定义的<code>JS</code>函数。（调用<code>JSValue</code>的<code>API</code>）</p>
<h4 id="OC版本-10"><a href="#OC版本-10" class="headerlink" title="OC版本"></a>OC版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NSString *jsStr2 = @&quot;var a = 1; var b = 2;&quot;;</span><br><span class="line">JSValue *value2 = [context evaluateScript:jsStr2];</span><br><span class="line">JSValue *jsValueA = context[@&quot;a&quot;];  // 运行js，定义的变量，存储在context中。</span><br><span class="line">JSValue *jsValueB = context[@&quot;b&quot;];</span><br><span class="line">NSLog(@&quot;JS a: %@;  JS a: %@&quot;, jsValueA, jsValueB); // JS a: 1;  JS a: 2</span><br></pre></td></tr></table></figure>
<h4 id="Swift版本-10"><a href="#Swift版本-10" class="headerlink" title="Swift版本"></a>Swift版本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: 取出js脚本执行后存储在JSContext对象中的变量</span></span><br><span class="line"><span class="keyword">let</span> jsValueA = context.objectForKeyedSubscript(<span class="string">"a"</span>)</span><br><span class="line"><span class="keyword">let</span> jsValueB = context.objectForKeyedSubscript(<span class="string">"b"</span>)</span><br><span class="line"><span class="type">NSLog</span>(<span class="string">"JS a: <span class="subst">\(String(describing: jsValueA)</span>);  JS b: <span class="subst">\(String(describing: jsValueB)</span>)"</span>) <span class="comment">//  JS a: Optional(1);  JS b: Optional(2)</span></span><br></pre></td></tr></table></figure>
<h3 id="取出存储的js变量，并修改"><a href="#取出存储的js变量，并修改" class="headerlink" title="取出存储的js变量，并修改"></a>取出存储的js变量，并修改</h3><p>对于<code>JS</code>的<code>Array</code>、<code>Object</code>类型，<code>JSValue</code>也可以通过下标直接取值和赋值。</p>
<h4 id="OC版本-11"><a href="#OC版本-11" class="headerlink" title="OC版本"></a>OC版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NSString *jsStr3 = @&quot;var arr = [88, &apos;mengyueping&apos;, 66];&quot;;</span><br><span class="line">JSValue *value3 = [context evaluateScript:jsStr3];</span><br><span class="line">JSValue *jsArr = context[@&quot;arr&quot;];</span><br><span class="line">NSLog(@&quot;value3 JS: %@  -&gt; OC: %@&quot;,value3, value3.toObject); // value2 JS: undefined  -&gt; OC: (null)</span><br><span class="line">NSLog(@&quot;JS Array: %@;  Length: %@; jsArr[0]：%@&quot;, jsArr, jsArr[@&quot;length&quot;], jsArr[0]); // JS Array: 20,10,www.mengyueping.com;  Length: 3; jsArr[0]：20</span><br><span class="line">jsArr[0] = @&quot;www.&quot;;</span><br><span class="line">jsArr[2] = @&quot;.com&quot;;</span><br><span class="line">NSLog(@&quot;通过下标对js取值赋值：JS Array: %@;  Length: %@; jsArr[0]：%@&quot;, jsArr, jsArr[@&quot;length&quot;], jsArr[0]); // JS Array: 20,10,www.mengyueping.com;  Length: 3; jsArr[0]：20</span><br></pre></td></tr></table></figure>
<h4 id="Swift版本-11"><a href="#Swift版本-11" class="headerlink" title="Swift版本"></a>Swift版本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: 取出存储的js变量，并修改</span></span><br><span class="line"><span class="keyword">let</span> jsStr3 = <span class="string">"var arr = [88, 'mengyueping', 66];"</span></span><br><span class="line"><span class="keyword">let</span> value3 = context.evaluateScript(jsStr3)</span><br><span class="line"><span class="keyword">let</span> jsArr = context.objectForKeyedSubscript(<span class="string">"arr"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"value3 JS: <span class="subst">\(String(describing: value3)</span>)  -&gt; Swift: <span class="subst">\(String(describing: value3?.toObject)</span>)"</span>);</span><br><span class="line"><span class="comment">// value3 JS: Optional(undefined)  -&gt; Swift: Optional((Function))</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"JS Array: <span class="subst">\(String(describing: jsArr)</span>);  Length: <span class="subst">\(String(describing: jsArr?.objectForKeyedSubscript("length")</span>)); jsArr[0]：<span class="subst">\(String(describing: jsArr?.objectAtIndexedSubscript(<span class="number">0</span>)</span>))"</span> )</span><br><span class="line"><span class="comment">// JS Array: Optional(88,mengyueping,66);  Length: Optional(3); jsArr[0]：Optional(88)</span></span><br><span class="line">jsArr?.setValue(<span class="string">"www."</span>, at: <span class="number">0</span>)</span><br><span class="line">jsArr?.setValue(<span class="string">".com"</span>, at: <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"通过下标对js取值赋值：JS Array: <span class="subst">\(String(describing: jsArr)</span>);  Length: <span class="subst">\(String(describing: jsArr?.objectForKeyedSubscript("length")</span>)); jsArr[0]：<span class="subst">\(String(describing: jsArr?.objectAtIndexedSubscript(<span class="number">0</span>)</span>))"</span> )</span><br><span class="line"><span class="comment">// 通过下标对js取值赋值：JS Array: Optional(www.,mengyueping,.com);  Length: Optional(3); jsArr[0]：Optional(www.)</span></span><br></pre></td></tr></table></figure>
<h3 id="取出存储的js集合对象，并转为OC数组对象"><a href="#取出存储的js集合对象，并转为OC数组对象" class="headerlink" title="取出存储的js集合对象，并转为OC数组对象"></a>取出存储的js集合对象，并转为OC数组对象</h3><h4 id="OC版本-12"><a href="#OC版本-12" class="headerlink" title="OC版本"></a>OC版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NSString *jsStr3 = @&quot;var arr = [88, &apos;mengyueping&apos;, 66];&quot;;</span><br><span class="line">JSValue *value3 = [context evaluateScript:jsStr3];</span><br><span class="line">JSValue *jsArr = context[@&quot;arr&quot;];</span><br><span class="line">NSArray *ocArr = jsArr.toArray;</span><br><span class="line">NSLog(@&quot;js Arr -&gt; OC Arr: %@&quot;, ocArr);</span><br><span class="line">/*</span><br><span class="line">    js Arr -&gt; OC Arr: (</span><br><span class="line">    &quot;www.&quot;,</span><br><span class="line">    mengyueping,</span><br><span class="line">    &quot;.com&quot;</span><br><span class="line">    )</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<h4 id="Swift版本-12"><a href="#Swift版本-12" class="headerlink" title="Swift版本"></a>Swift版本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> swiftArr = jsArr?.toArray()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"js Arr -&gt; Swift Arr: <span class="subst">\(String(describing: swiftArr)</span>)"</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">js Arr -&gt; Swift Arr: Optional([www., mengyueping, .com])</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="取出存储的js集合对象，并直接使用OC对象给js对象赋值"><a href="#取出存储的js集合对象，并直接使用OC对象给js对象赋值" class="headerlink" title="取出存储的js集合对象，并直接使用OC对象给js对象赋值"></a>取出存储的js集合对象，并直接使用OC对象给js对象赋值</h3><p><code>JSValue</code>是遵循<code>JS</code>的数组特性：没有下标越位，自动延展数组大小。即：集合中没有的下标，元素会自动补空。并且通过<code>JSValue</code>还可以获取<code>JS</code>对象上的属性，比如：JS数组的长度“length”。</p>
<h4 id="OC版本-13"><a href="#OC版本-13" class="headerlink" title="OC版本"></a>OC版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">NSString *jsStr3 = @&quot;var arr = [88, &apos;mengyueping&apos;, 66];&quot;;</span><br><span class="line">JSValue *value3 = [context evaluateScript:jsStr3];</span><br><span class="line">JSValue *jsArr = context[@&quot;arr&quot;];</span><br><span class="line">jsArr[8] = @8;</span><br><span class="line">NSLog(@&quot;通过下标对js取值赋值：JS Array: %@;  Length: %@; jsArr[0]：%@&quot;, jsArr, jsArr[@&quot;length&quot;], jsArr[0]);</span><br><span class="line">// 通过下标对js取值赋值：JS Array: www.,mengyueping,.com,,,,,,8;  Length: 9; jsArr[0]：www.</span><br><span class="line">NSLog(@&quot;js Arr -&gt; OC Arr: %@&quot;, jsArr.toArray);</span><br><span class="line">/*</span><br><span class="line">    js Arr -&gt; OC Arr: (</span><br><span class="line">    &quot;www.&quot;,</span><br><span class="line">    mengyueping,</span><br><span class="line">    &quot;.com&quot;,</span><br><span class="line">    &quot;&lt;null&gt;&quot;,</span><br><span class="line">    &quot;&lt;null&gt;&quot;,</span><br><span class="line">    &quot;&lt;null&gt;&quot;,</span><br><span class="line">    &quot;&lt;null&gt;&quot;,</span><br><span class="line">    &quot;&lt;null&gt;&quot;,</span><br><span class="line">    8</span><br><span class="line">    )</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<h4 id="Swift版本-13"><a href="#Swift版本-13" class="headerlink" title="Swift版本"></a>Swift版本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: 取出存储的js集合对象，并直接使用Swift对象给js对象赋值</span></span><br><span class="line">jsArr?.setValue(<span class="number">8</span>, at: <span class="number">8</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"通过下标对js取值赋值：JS Array: <span class="subst">\(String(describing: jsArr)</span>);  Length: <span class="subst">\(String(describing: jsArr?.objectForKeyedSubscript("length")</span>)); jsArr[0]：<span class="subst">\(String(describing: jsArr?.objectAtIndexedSubscript(<span class="number">0</span>)</span>))"</span> )</span><br><span class="line"><span class="comment">// 通过下标对js取值赋值：JS Array: Optional(www.,mengyueping,.com,,,,,,8);  Length: Optional(9); jsArr[0]：Optional(www.)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"js Arr -&gt; Swift Arr: <span class="subst">\(String(describing: jsArr?.toArray()</span>))"</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">js Arr -&gt; Swift Arr: Optional([www., mengyueping, .com, &lt;null&gt;, &lt;null&gt;, &lt;null&gt;, &lt;null&gt;, &lt;null&gt;, 8])</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="取出存储的js函数，并执行"><a href="#取出存储的js函数，并执行" class="headerlink" title="取出存储的js函数，并执行"></a>取出存储的js函数，并执行</h3><p>使用<code>JSValue</code>的<code>API</code>执行<code>JS</code>函数，且有参数的，可以传参。</p>
<h4 id="OC版本-14"><a href="#OC版本-14" class="headerlink" title="OC版本"></a>OC版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[context evaluateScript:@&quot;function add(a, b)&#123; return a + b; &#125;&quot;];</span><br><span class="line">JSValue *addValue = context[@&quot;add&quot;]; // js函数</span><br><span class="line">NSLog(@&quot;Func: %@&quot;, addValue);  // Func: function add(a, b)&#123; return a + b; &#125;</span><br><span class="line"></span><br><span class="line">// 取出js函数，调用函数 - (JSValue *)callWithArguments:(NSArray *)arguments;</span><br><span class="line">JSValue *sum = [addValue callWithArguments:@[@1,@2]];</span><br><span class="line">NSLog(@&quot;Sum: %d&quot;, sum.toInt32); // Sum: 3</span><br></pre></td></tr></table></figure>
<h4 id="Swift版本-14"><a href="#Swift版本-14" class="headerlink" title="Swift版本"></a>Swift版本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: 取出存储的js函数，并执行</span></span><br><span class="line">context.evaluateScript(<span class="string">"function add(a, b)&#123; return a + b; &#125;"</span>)</span><br><span class="line"><span class="keyword">let</span> addValue = context.objectForKeyedSubscript(<span class="string">"add"</span>) <span class="comment">// js函数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Func: <span class="subst">\(String(describing: addValue)</span>)"</span>)  <span class="comment">// Func: Optional(function add(a, b)&#123; return a + b; &#125;)</span></span><br><span class="line"><span class="comment">// 取出js函数，调用函数 open func call(withArguments arguments: [Any]!) -&gt; JSValue!</span></span><br><span class="line"><span class="keyword">let</span> sum = addValue?.call(withArguments:[<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Sum: <span class="subst">\(String(describing: sum?.toInt32()</span>))"</span>) <span class="comment">// Sum: Optional(3)</span></span><br></pre></td></tr></table></figure>
<h3 id="调用js函数的另一种简单方法"><a href="#调用js函数的另一种简单方法" class="headerlink" title="调用js函数的另一种简单方法"></a>调用js函数的另一种简单方法</h3><p>不必像上面一样先取出存储的<code>JS</code>函数，再执行<code>JS</code>函数。直接使用<code>JSContext</code>对象的<code>JSValue *globalObject;</code>属性，调用<code>JSValue</code>对象的<code>- (JSValue *)invokeMethod:(NSString *)method withArguments:(NSArray *)arguments;</code>方法。如果定义的<code>JS</code>函数是全局函数，应该用<code>JSContext</code>的<code>globalObject</code>对象调用该方法。如果是某<code>JS</code>对象的方法，就应该用相应的<code>JSValue</code>对象调用。</p>
<h4 id="OC版本-15"><a href="#OC版本-15" class="headerlink" title="OC版本"></a>OC版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JSValue *jsValue = [context evaluateScript:@&quot;function multiply(a, b)&#123; return a * b; &#125;&quot;];</span><br><span class="line">JSValue *multiplyValue = [jsValue.context.globalObject invokeMethod:@&quot;multiply&quot; withArguments:@[@3,@6]]; //第一种形式</span><br><span class="line">NSLog(@&quot;multiplyValue: %d&quot;,multiplyValue.toInt32); // multiplyValue: 18</span><br></pre></td></tr></table></figure>
<p>或者：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JSValue *jsValue = [context evaluateScript:@&quot;function multiply(a, b)&#123; return a * b; &#125;&quot;];</span><br><span class="line">JSValue *multiplyValue = [context.globalObject invokeMethod:@&quot;multiply&quot; withArguments:@[@3,@6]]; //第二种形式</span><br><span class="line">NSLog(@&quot;multiplyValue: %d&quot;,multiplyValue.toInt32); // multiplyValue: 18</span><br></pre></td></tr></table></figure></p>
<h4 id="Swift版本-15"><a href="#Swift版本-15" class="headerlink" title="Swift版本"></a>Swift版本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK:  调用js函数的另一种简单方法</span></span><br><span class="line"><span class="keyword">let</span> jsValue = context.evaluateScript(<span class="string">"function multiply(a, b)&#123; return a * b; &#125;"</span>)</span><br><span class="line"><span class="keyword">let</span> multiplyValue = jsValue?.context.globalObject.invokeMethod(<span class="string">"multiply"</span>, withArguments: [<span class="number">3</span>,<span class="number">6</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"multiplyValue: <span class="subst">\(String(describing: multiplyValue?.toInt32()</span>))"</span>); <span class="comment">// multiplyValue: Optional(18)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> multiplyValue = context.globalObject.invokeMethod(<span class="string">"multiply"</span>, withArguments: [<span class="number">3</span>,<span class="number">6</span>])</span><br></pre></td></tr></table></figure>
<h3 id="把OC中Block转换成JS函数，并存储到JSContext对象"><a href="#把OC中Block转换成JS函数，并存储到JSContext对象" class="headerlink" title="把OC中Block转换成JS函数，并存储到JSContext对象"></a>把OC中Block转换成JS函数，并存储到JSContext对象</h3><p>通过<code>Block</code>可以实现在<code>OC/Swift</code>中定义<code>JS</code>函数，并且在<code>JS</code>运行环境中调用该<code>JS</code>函数，函数执行可以成功的回到<code>OC/Swift</code>的<code>Block/Closure</code>代码中，而且遵循<code>JS</code>方法的各种特点（比如：方法参数不固定）。<code>JSContext</code>提供了类方法来获取参数列表 <code>(+(NSArray *)currentArguments)</code>和当前调用该方法的对象<code>(+ (JSValue *)currentThis)</code>。<code>JS</code>函数中<code>this</code>的输出的内容是<code>GlobalObject</code>，也是<code>JSContext</code>对象方法 <code>-(JSValue *)globalObject;</code>所返回的内容。因为在<code>JS</code>里面，所有全局变量和方法其实都是一个全局变量(<code>GlobalObject</code>)的属性，在浏览器中是<code>window</code>对象。如下，使用<code>Block/Closure</code>定义一个<code>JS</code>函数<code>log</code>。并在<code>JS</code>脚本中调用<code>log</code>函数，并使用<code>OC</code>执行此脚本。</p>
<h4 id="OC版本-16"><a href="#OC版本-16" class="headerlink" title="OC版本"></a>OC版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">context[@&quot;log&quot;] = ^()&#123;</span><br><span class="line">    NSLog(@&quot;++++++Begin Log++++++&quot;);</span><br><span class="line">    </span><br><span class="line">    NSArray *args = [JSContext currentArguments];</span><br><span class="line">    for (JSValue *jsVal in args) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;,jsVal);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    JSValue *this = [JSContext currentThis];</span><br><span class="line">    NSLog(@&quot;this: %@&quot;, this);</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;---End Log------&quot;);</span><br><span class="line">&#125;;</span><br><span class="line">// 执行js，调用使用Block自定义的js函数</span><br><span class="line">[context evaluateScript:@&quot;log(&apos;mengyueping&apos;, [10,20], &#123;&apos;hello&apos;: &apos;world&apos;, &apos;number&apos;: &apos;100&apos;&#125;)&quot;];</span><br><span class="line">/*</span><br><span class="line">    ++++++Begin Log++++++</span><br><span class="line">    mengyueping</span><br><span class="line">    10,20</span><br><span class="line">    [object Object]</span><br><span class="line">    this: [object GlobalObject]</span><br><span class="line">    ---End Log------</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<h4 id="Swift版本-16"><a href="#Swift版本-16" class="headerlink" title="Swift版本"></a>Swift版本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: 把Swift中Closure转换成JS函数，并存储到JSContext对象</span></span><br><span class="line"><span class="keyword">let</span> block: <span class="meta">@convention</span>(block) () -&gt; () = &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"++++++Begin Log++++++"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> args = <span class="type">JSContext</span>.currentArguments()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> jsVal <span class="keyword">in</span> args! &#123;</span><br><span class="line">        <span class="built_in">print</span>(jsVal)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> this = <span class="type">JSContext</span>.currentThis()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"this: <span class="subst">\(String(describing: this)</span>)"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"---End Log------"</span>)</span><br><span class="line">&#125;</span><br><span class="line">context.setObject(block, forKeyedSubscript: <span class="type">NSString</span>(string: <span class="string">"log"</span>))</span><br><span class="line"><span class="comment">// 执行js，调用使用Block自定义的js函数</span></span><br><span class="line">context.evaluateScript(<span class="string">"log('mengyueping', [10,20], &#123;'hello': 'world', 'number': '100'&#125;)"</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">++++++Begin Log++++++</span></span><br><span class="line"><span class="comment">mengyueping</span></span><br><span class="line"><span class="comment">10,20</span></span><br><span class="line"><span class="comment">[object Object]</span></span><br><span class="line"><span class="comment">this: Optional([object GlobalObject])</span></span><br><span class="line"><span class="comment">---End Log------</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>对<code>JSContext</code>和<code>JSValue</code>实例使用下标的方式我们可以很容易地访问我们之前创建的<code>context</code>的任何值。<code>JSContext</code>需要一个字符串下标，而<code>JSValue</code>允许使用字符串或整数作为下标来得到里面的<code>JS</code>对象和数组。</p>
<p><code>Block</code>可以传入<code>JSContext</code>作方法，但是<code>JSValue</code>没有<code>toBlock</code>方法来把<code>JS</code>方法变成<code>Block/Closure</code>在<code>OC/Swift</code>中使用。但是，<code>JSValue</code>提供了<code>-(JSValue *)callWithArguments:(NSArray *)arguments;</code>方法，可以反过来将函数参数传进去。</p>
<p><code>Block</code>在<code>JavaScriptCore</code>中起到强大作用，它为<code>JS</code>和<code>OC</code>之间的转换建立起更多的桥梁，让转换更方便。但需要注意：</p>
<ul>
<li>在<code>block</code>内部使用外部定义创建的对象，<code>block</code>会对其做强引用，而<code>JSContext</code>也会对被赋予的<code>block</code>做强引用，这样它们之间就形成了循环引用<code>（Circular Reference）</code>使得内存无法正常释放。</li>
<li>在<code>block</code>内部使用外部定义创建的<code>JSValue</code>对象，也会造成循环引用，因为每个<code>JSValue</code>上都有<code>JSContext</code>的引用<code>（@property (readonly, strong) JSContext *context;）</code>，<code>JSContext</code>再引用<code>Block</code>同样也会形成循环引用。</li>
<li>无论是把<code>Block</code>传给<code>JSContext</code>对象，让其变成<code>JS</code>方法；还是把它赋值给<code>exceptionHandler</code>属性；在<code>Block</code>内都不要直接使用其外部定义的<code>JSContext/JSValue</code>对象，应该将其当做参数传入到<code>Block</code>中，或者通过<code>JSContext</code>的类方法<code>+(JSContext *)currentContext;</code>来获得。否则会造成循环引用使得内存无法被正确释放。</li>
</ul>
<h2 id="JSContext结合UIWebView处理HTML中事件监听"><a href="#JSContext结合UIWebView处理HTML中事件监听" class="headerlink" title="JSContext结合UIWebView处理HTML中事件监听"></a>JSContext结合UIWebView处理HTML中事件监听</h2><p><code>JSContext</code>结合<code>UIWebView</code>，当点击<code>JS</code>函数时，响应<code>OC/Swift</code>操作。通过<code>UIWebView</code>的方法<code>JSContext *context = [self.webView valueForKeyPath:@&quot;documentView.webView.mainFrame.javaScriptContext&quot;];</code>获取<code>JSContext</code>对象。 <code>Swift</code>中是<code>let context = webView.value(forKeyPath: &quot;documentView.webView.mainFrame.javaScriptContext&quot;)</code>。</p>
<p>而<code>WKWebView</code>不支持通过<code>KVC</code>的方式创建<code>JSContext</code>，所以不能在<code>WKWebView</code>中使用<code>JavaScriptCore</code>。<br><code>WKWebView</code>中<code>OC/Swift</code>与<code>JS</code>交互的方式，更简洁，因此也用不到<code>JavaScriptCore</code>。</p>
<h3 id="加载的HTML"><a href="#加载的HTML" class="headerlink" title="加载的HTML"></a>加载的HTML</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScriptCore<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">            function showAlert(content) &#123;</span></span><br><span class="line"><span class="undefined">                asyncAlert(content);</span></span><br><span class="line"><span class="undefined">                document.getElementById("js-iOS-js-argsValue").value = content;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">            function asyncAlert(content) &#123;</span></span><br><span class="line"><span class="undefined">                setTimeout(function()&#123; alert(content); &#125;, 1);</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是按钮调用<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">'jsBtn'</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">style</span>=<span class="string">"width:300px;height:50px;"</span> <span class="attr">value</span>=<span class="string">"点击Html按钮，调用OC/Swift要执行的代码，&amp;#13;&amp;#10;接收JS传递给OC/Swift的参数"</span> <span class="attr">onclick</span>=<span class="string">"handleJSToiOS('触发了Html中标签的点击事件，触发JS函数调用，js-&gt;OC/Swift-&gt;JS')"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span> =<span class="string">"js-iOS-js-argsValue"</span> <span class="attr">type</span>=<span class="string">"value"</span> <span class="attr">rows</span>=<span class="string">"5"</span> <span class="attr">cols</span>=<span class="string">"50"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="OC版本-17"><a href="#OC版本-17" class="headerlink" title="OC版本"></a>OC版本</h3><p>代码<code>context[@&quot;jsMethodName&quot;] = ^(){//执行的OC代码};</code>其中，<code>jsMethodName</code>是<code>JS</code>中触发事件的方法名字；<code>^(){//执行的OC代码}</code> 这个<code>block</code>通过<code>JSContext</code>对象变成名字为<code>jsMethodName</code>的<code>JS</code>方法；所以当触发<code>Html</code>点击事件所监听的<code>jsMethodName</code>方法时，就等于触发了<code>OC</code>的<code>Block</code>中的代码。</p>
<p><code>Block</code>中的执行环境是子线程。可以更新部分<code>UI</code>：<code>view</code>设置背景色、调用<code>webView</code>执行<code>js</code>。弹出原生<code>alertView</code>会<code>Crash</code>子线程操作<code>UI</code>的错误信息。 </p>
<p><code>Block</code>避免循环引用，因为<code>block</code>会持有外部变量，而<code>JSContext</code>也会强引用它所有的变量，<code>self</code>使用<code>weakSelf</code>。<code>block</code>内不要使用外部的<code>JSContext</code>对象、<code>JSValue</code>对象。如果要使用<code>JSContext</code>对象，可以使用<code>[JSContext currentContext]</code>，也可以把<code>JSContext</code>对象、<code>JSValue</code>对象当做<code>block</code>的参数传入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">self.view.backgroundColor = [UIColor whiteColor];</span><br><span class="line">CGRect webFrame = CGRectMake(30, 80, self.view.bounds.size.width-60, self.view.bounds.size.height-100);</span><br><span class="line">UIWebView *webView = [[UIWebView alloc] initWithFrame:webFrame];</span><br><span class="line">NSURL *htmlUrl = [[NSBundle mainBundle] URLForResource:@&quot;index.html&quot; withExtension:nil];</span><br><span class="line">//    NSURL *htmlUrl = [NSURL URLWithString:@&quot;&quot;];</span><br><span class="line">NSURLRequest *request = [NSURLRequest requestWithURL:htmlUrl];</span><br><span class="line"></span><br><span class="line">webView.scrollView.bounces = NO; //关闭webView的回弹效果</span><br><span class="line">webView.scrollView.decelerationRate = UIScrollViewDecelerationRateNormal;//UIWebView滚动的比较慢，这里设置为正常速度</span><br><span class="line"></span><br><span class="line">[webView loadRequest:request];</span><br><span class="line">[self.view addSubview:webView];</span><br><span class="line">self.webView = webView;</span><br><span class="line">self.webView.delegate = self;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - UIWebViewDelegate</span><br><span class="line">- (void)webViewDidFinishLoad:(UIWebView *)webView</span><br><span class="line">&#123;</span><br><span class="line">    __weak typeof (self) weakSelf = self;</span><br><span class="line">    </span><br><span class="line">    JSContext *context = [self.webView valueForKeyPath:@&quot;documentView.webView.mainFrame.javaScriptContext&quot;];</span><br><span class="line">    </span><br><span class="line">    context[@&quot;handleJSToiOS&quot;] = ^()&#123;</span><br><span class="line">        NSLog(@&quot;CurrentThread: %@&quot;,[NSThread currentThread]); //此Block是子线程</span><br><span class="line">        </span><br><span class="line">        // 获取js函数传入的参数</span><br><span class="line">        NSArray *args = [JSContext currentArguments];</span><br><span class="line">        for (int i = 0; i&lt;args.count; i++) &#123;</span><br><span class="line">            NSLog(@&quot;args[%d]: %@&quot;,i,args[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 使用JSContext执行JS代码，将JS传递给OC/Swift的数据，传递回JS</span><br><span class="line">        //方法一：</span><br><span class="line">        NSString *jsStr = [NSString stringWithFormat:@&quot;showAlert(&apos;%@&apos;)&quot;,args[0]];</span><br><span class="line">        [[JSContext currentContext] evaluateScript:jsStr];</span><br><span class="line">        </span><br><span class="line">        //方法二：</span><br><span class="line">        [[JSContext currentContext][@&quot;showAlert&quot;] callWithArguments:args];</span><br><span class="line">        </span><br><span class="line">        // 修改原生UI</span><br><span class="line">        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;  //回到主线程</span><br><span class="line">            </span><br><span class="line">            weakSelf.view.backgroundColor = [UIColor orangeColor];</span><br><span class="line">            </span><br><span class="line">            // BOM操作</span><br><span class="line">//            [weakSelf.webView goBack];</span><br><span class="line">//            [weakSelf.webView goForward];</span><br><span class="line">//            [weakSelf.webView reload];</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 播放系统音效</span><br><span class="line">        AudioServicesPlaySystemSound(1007); // 1007是系统声音的编号</span><br><span class="line">        </span><br><span class="line">        /*</span><br><span class="line">         此处可以执行的任务：</span><br><span class="line">             获取地理位置信息、调用相机、扫一扫二维码、调用系统分享面板、更改原生控件属性样式（回到主线程）、</span><br><span class="line">             原生调用支付（JS把支付参数传递给OC/Swfit进行支付、OC/Swfit把支付结果反馈给JS）、</span><br><span class="line">             摇一摇、播放系统音效、</span><br><span class="line">         */</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Swift版本-17"><a href="#Swift版本-17" class="headerlink" title="Swift版本"></a>Swift版本</h3><p>代码<code>jscontext.setObject(block, forKeyedSubscript: NSString(string: &quot;handleJSToiOS&quot;))</code>其中，<code>block</code>是自己定义的一个<code>@convention(block)</code>的<code>Closure</code>；<code>handleJSToiOS</code>是<code>JS</code>中触发事件的方法名字；这个自定义的闭包通过<code>JSContext</code>对象，将存储的代码块变成名字为<code>jsMethodName</code>的<code>JS</code>方法；所以当触发<code>Html</code>点击事件所监听的<code>jsMethodName</code>方法时，就等于触发了<code>Swift</code>的<code>Closure</code>中的代码。</p>
<p> <code>Closure</code>中的执行环境是子线程。可以更新部分<code>UI</code>：<code>view</code>设置背景色、调用<code>webView</code>执行<code>js</code>。弹出原生<code>alertView</code>会<code>Crash</code>子线程操作<code>UI</code>的错误信息。</p>
<p><code>Closure</code>避免循环引用，因为<code>Closure</code>会持有外部变量，而<code>JSContext</code>也会强引用它所有的变量，闭包中声明<code>self</code>为弱引用<code>[weak self]</code>。<code>Closure</code>内不要使用外部的<code>JSContext</code>对象、<code>JSValue</code>对象。如果要使用<code>JSContext</code>对象，可以使用<code>JSContext.current()</code>，也可以把<code>JSContext</code>对象、<code>JSValue</code>对象当做<code>Closure</code>的参数传入。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(#function)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> webView: <span class="type">UIWebView</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> web = <span class="type">UIWebView</span>(frame: <span class="type">CGRect</span>(x: <span class="number">30</span>, y: <span class="number">80</span>, width: <span class="type">UIScreen</span>.main.bounds.width-<span class="number">60</span>, height: <span class="type">UIScreen</span>.main.bounds.height-<span class="number">160</span>))</span><br><span class="line">        web.delegate = <span class="keyword">self</span></span><br><span class="line">        <span class="keyword">return</span> web</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        view.backgroundColor = <span class="type">UIColor</span>.white</span><br><span class="line">        view.addSubview(webView)</span><br><span class="line"><span class="comment">//        let url = URL(string: "https://www..com")!</span></span><br><span class="line">        <span class="keyword">let</span> url = <span class="type">Bundle</span>.main.url(forResource:<span class="string">"index"</span>, withExtension:<span class="string">"html"</span>)!</span><br><span class="line">        webView.loadRequest(<span class="type">URLRequest</span>(url: url))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: 代理 UIWebViewDelegate</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">UIWebViewDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webViewDidFinishLoad</span><span class="params">(<span class="number">_</span> webView: UIWebView)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(#function)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> context = webView.value(forKeyPath: <span class="string">"documentView.webView.mainFrame.javaScriptContext"</span>)</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> jsContext = context <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">let</span> jscontext = jsContext <span class="keyword">as</span>! <span class="type">JSContext</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> block: <span class="meta">@convention</span>(block) () -&gt; () = &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"CurrentThread: <span class="subst">\(Thread.current)</span>"</span>) <span class="comment">//此Closure是子线程</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获取js函数传入的参数</span></span><br><span class="line">            <span class="keyword">let</span> args = <span class="type">JSContext</span>.currentArguments()</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> argments = args <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> argments &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"args[<span class="subst">\(i)</span>]: <span class="subst">\(item)</span>"</span>)</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 使用JSContext执行JS代码，将JS传递给OC/Swift的数据，传递回JS</span></span><br><span class="line">            <span class="comment">//方法一：</span></span><br><span class="line"><span class="comment">//            JSContext.current().evaluateScript("showAlert('\(argments[0])')")</span></span><br><span class="line">            <span class="comment">//方法二：</span></span><br><span class="line">            <span class="type">JSContext</span>.current().objectForKeyedSubscript(<span class="string">"showAlert"</span>).call(withArguments: argments)</span><br><span class="line"><span class="comment">//            JSContext.current().objectForKeyedSubscript("alert").call(withArguments: argments)</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 修改原生UI</span></span><br><span class="line">            <span class="type">DispatchQueue</span>.main.async &#123; <span class="comment">//回到主线程</span></span><br><span class="line">                <span class="keyword">self</span>!.view.backgroundColor = <span class="type">UIColor</span>.orange</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// BOM操作</span></span><br><span class="line"><span class="comment">//                self!.webView.reload()</span></span><br><span class="line"><span class="comment">//                self!.webView.goForward()</span></span><br><span class="line"><span class="comment">//                self!.webView.goBack()</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 播放系统音效</span></span><br><span class="line">            <span class="type">AudioServicesPlaySystemSound</span>(<span class="number">1007</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             此处可以执行的任务：</span></span><br><span class="line"><span class="comment">                 获取地理位置信息、调用相机、扫一扫二维码、调用系统分享面板、更改原生控件属性样式（回到主线程）、</span></span><br><span class="line"><span class="comment">                 原生调用支付（JS把支付参数传递给OC/Swfit进行支付、OC/Swfit把支付结果反馈给JS）、</span></span><br><span class="line"><span class="comment">                 摇一摇、播放系统音效、</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;</span><br><span class="line">        jscontext.setObject(block, forKeyedSubscript: <span class="type">NSString</span>(string: <span class="string">"handleJSToiOS"</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="JSVirtualMachine"><a href="#JSVirtualMachine" class="headerlink" title="JSVirtualMachine"></a>JSVirtualMachine</h2><blockquote>
<p><code>JSVirtualMachine</code>为<code>JS</code>脚本的执行提供底层资源。一个<code>JSVirtualMachine</code>实例，代表一个独立的<code>JS</code>对象空间，并为其执行提供资源。它通过加锁，保证<code>JSVirtualMachine</code>是线程安全的，如果要并发执行<code>JS</code>，那我们必须创建多个独立的<code>JSVirtualMachine</code>实例，在不同的实例中执行<code>JS</code>（有点像JS引擎，如V8）。有独立的堆空间和垃圾回收机制。处理线程相关，使用较少。</p>
</blockquote>
<p>通过<code>alloc/init</code>就可以创建一个<code>JSVirtualMachine</code>对象，但是我们一般不用新建<code>JSVirtualMachine</code>对象，因为创建<code>JSContext</code>时，如果我们不提供一个自己创建的<code>JSVirtualMachine</code>，内部会自动创建一个<code>JSVirtualMachine</code>对象。<code>JSContext</code>对象管理<code>JSVirtualMachine</code>对象的生命周期。</p>
<p><code>JSVirtualMachine</code>创建方式：<br>方式一，创建<code>JSContext</code>对象时，内部自动创建一个新的<code>JSVirtualMachine</code>对象。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//OC</span><br><span class="line">JSContext *context = [[JSContext alloc] init];</span><br></pre></td></tr></table></figure></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Swift</span></span><br><span class="line"><span class="keyword">let</span> context = <span class="type">JSContext</span>()</span><br></pre></td></tr></table></figure>
<p>方式二，自己创建一个<code>JSVirtualMachine</code>对象，传入的创建<code>JSContext</code>对象中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//OC</span><br><span class="line">JSVirtualMachine *jsVM = [[JSVirtualMachine alloc] init];</span><br><span class="line">JSContext *context = [[JSContext alloc] initWithVirtualMachine:jsVM]; //传入的JSVirtualMachine对象不能为空</span><br></pre></td></tr></table></figure></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Swift</span></span><br><span class="line"><span class="keyword">let</span> jsVM = <span class="type">JSVirtualMachine</span>()</span><br><span class="line"><span class="keyword">let</span> <span class="built_in">c</span> = <span class="type">JSContext</span>(virtualMachine: jsVM)</span><br></pre></td></tr></table></figure>
<p><code>JSVirtualMachine</code>为<code>JavaScript</code>的运行<strong>提供了底层资源</strong>，<code>JSContext</code>为<code>JavaScript</code><strong>提供了运行环境</strong>;<br>而<code>JSContext</code>的创建都是基于<code>JSVirtualMachine</code>。<br><code>JSValue</code>其实就是<code>JS</code>对象在<code>JSVirtualMachine</code>中的一个强引用。</p>
<p>=================<br>本文代码，我的<code>Github</code>仓库获取<a href="https://github.com/MengYP/apple-stack/tree/master/iOS_JavaScript/iOS-callJavaScript" target="_blank" rel="noopener">apple-stack</a></p>
<p>=================<br>2017.7更新</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>🐶 客观赏个好评吧 🐶</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/uploads/wechatpay.png" alt="孟跃平 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/uploads/alipay.png" alt="孟跃平 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/Swift/" rel="tag"># Swift</a>
          
            <a href="/tags/OC/" rel="tag"># OC</a>
          
            <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
          
            <a href="/tags/JavaScriptCore/" rel="tag"># JavaScriptCore</a>
          
            <a href="/tags/UIWebView/" rel="tag"># UIWebView</a>
          
            <a href="/tags/WKWebView/" rel="tag"># WKWebView</a>
          
            <a href="/tags/HTML/" rel="tag"># HTML</a>
          
            <a href="/tags/WebKit/" rel="tag"># WebKit</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/02/iOS-JSExport-JSCallOC-Swift/" rel="prev" title="JSExport实现JS调用OC/Swift">
                JSExport实现JS调用OC/Swift <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.png"
                alt="孟跃平" />
            
              <p class="site-author-name" itemprop="name">孟跃平</p>
              <p class="site-description motion-element" itemprop="description">stay hungry, stay foolish</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/MengYP" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:mengcoder@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#OC-Swift与JavaScript交互"><span class="nav-number">1.</span> <span class="nav-text">OC/Swift与JavaScript交互</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#问题"><span class="nav-number">1.1.</span> <span class="nav-text">问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iOS中加载HTML页面"><span class="nav-number">2.</span> <span class="nav-text">iOS中加载HTML页面</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#UIWebView"><span class="nav-number">2.1.</span> <span class="nav-text">UIWebView</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OC版本"><span class="nav-number">2.1.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Swift版本"><span class="nav-number">2.1.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WKWebView"><span class="nav-number">2.2.</span> <span class="nav-text">WKWebView</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OC版本-1"><span class="nav-number">2.2.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Swift版本-1"><span class="nav-number">2.2.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iOS中执行一段JavaScript代码"><span class="nav-number">3.</span> <span class="nav-text">iOS中执行一段JavaScript代码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用UIWebView执行JS代码"><span class="nav-number">3.1.</span> <span class="nav-text">使用UIWebView执行JS代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OC版本-2"><span class="nav-number">3.1.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Swift版本-2"><span class="nav-number">3.1.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用WKWebView执行JS代码"><span class="nav-number">3.2.</span> <span class="nav-text">使用WKWebView执行JS代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OC版本-3"><span class="nav-number">3.2.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Swift版本-3"><span class="nav-number">3.2.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iOS中监听JavaScript函数调用"><span class="nav-number">4.</span> <span class="nav-text">iOS中监听JavaScript函数调用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用UIWebView监听JS函数调用"><span class="nav-number">4.1.</span> <span class="nav-text">使用UIWebView监听JS函数调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OC版本-4"><span class="nav-number">4.1.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Swift版本-4"><span class="nav-number">4.1.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用WKWebView监听JS函数调用"><span class="nav-number">4.2.</span> <span class="nav-text">使用WKWebView监听JS函数调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OC版本-5"><span class="nav-number">4.2.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Swift版本-5"><span class="nav-number">4.2.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WKWebView与JS之间的通信"><span class="nav-number">4.3.</span> <span class="nav-text">WKWebView与JS之间的通信</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OC版本-6"><span class="nav-number">4.3.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Swift版本-6"><span class="nav-number">4.3.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iOS中利用JavaScriptCore交互JS"><span class="nav-number">5.</span> <span class="nav-text">iOS中利用JavaScriptCore交互JS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用JSContext运行JS代码"><span class="nav-number">5.1.</span> <span class="nav-text">使用JSContext运行JS代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化JSContext对象及异常处理"><span class="nav-number">5.1.1.</span> <span class="nav-text">初始化JSContext对象及异常处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OC版本-7"><span class="nav-number">5.1.1.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift版本-7"><span class="nav-number">5.1.1.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行带返回结果js脚本"><span class="nav-number">5.1.2.</span> <span class="nav-text">执行带返回结果js脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OC版本-8"><span class="nav-number">5.1.2.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift版本-8"><span class="nav-number">5.1.2.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行不带返回结果js脚本"><span class="nav-number">5.1.3.</span> <span class="nav-text">执行不带返回结果js脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OC版本-9"><span class="nav-number">5.1.3.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift版本-9"><span class="nav-number">5.1.3.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取出js脚本执行后存储在JSContext对象中的变量"><span class="nav-number">5.1.4.</span> <span class="nav-text">取出js脚本执行后存储在JSContext对象中的变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OC版本-10"><span class="nav-number">5.1.4.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift版本-10"><span class="nav-number">5.1.4.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取出存储的js变量，并修改"><span class="nav-number">5.1.5.</span> <span class="nav-text">取出存储的js变量，并修改</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OC版本-11"><span class="nav-number">5.1.5.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift版本-11"><span class="nav-number">5.1.5.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取出存储的js集合对象，并转为OC数组对象"><span class="nav-number">5.1.6.</span> <span class="nav-text">取出存储的js集合对象，并转为OC数组对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OC版本-12"><span class="nav-number">5.1.6.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift版本-12"><span class="nav-number">5.1.6.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取出存储的js集合对象，并直接使用OC对象给js对象赋值"><span class="nav-number">5.1.7.</span> <span class="nav-text">取出存储的js集合对象，并直接使用OC对象给js对象赋值</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OC版本-13"><span class="nav-number">5.1.7.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift版本-13"><span class="nav-number">5.1.7.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取出存储的js函数，并执行"><span class="nav-number">5.1.8.</span> <span class="nav-text">取出存储的js函数，并执行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OC版本-14"><span class="nav-number">5.1.8.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift版本-14"><span class="nav-number">5.1.8.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调用js函数的另一种简单方法"><span class="nav-number">5.1.9.</span> <span class="nav-text">调用js函数的另一种简单方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OC版本-15"><span class="nav-number">5.1.9.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift版本-15"><span class="nav-number">5.1.9.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#把OC中Block转换成JS函数，并存储到JSContext对象"><span class="nav-number">5.1.10.</span> <span class="nav-text">把OC中Block转换成JS函数，并存储到JSContext对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OC版本-16"><span class="nav-number">5.1.10.1.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift版本-16"><span class="nav-number">5.1.10.2.</span> <span class="nav-text">Swift版本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSContext结合UIWebView处理HTML中事件监听"><span class="nav-number">5.2.</span> <span class="nav-text">JSContext结合UIWebView处理HTML中事件监听</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#加载的HTML"><span class="nav-number">5.2.1.</span> <span class="nav-text">加载的HTML</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OC版本-17"><span class="nav-number">5.2.2.</span> <span class="nav-text">OC版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Swift版本-17"><span class="nav-number">5.2.3.</span> <span class="nav-text">Swift版本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSVirtualMachine"><span class="nav-number">5.3.</span> <span class="nav-text">JSVirtualMachine</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">孟跃平</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://www.mengyueping.com/2016/10/16/iOS-callJavaScript/';
          this.page.identifier = '2016/10/16/iOS-callJavaScript/';
          this.page.title = 'Objective-C/Swift与JavaScript交互';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("bSSS0Dg4QVv1p0FAHGaWv8Ei-gzGzoHsz", "UcKuDEryAx1QLVWeFLQHrUns");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
